<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>swapé¡¹ç›®æ‹†è§£ | ä»Šæ—¥äº‹ä»Šæ—¥æ¯•</title><meta name="author" content="Li"><meta name="copyright" content="Li"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="admincreate_amm_config(åˆ›å»º AMM é…ç½®)update_amm_config(æ›´æ–° AMM é…ç½®)update_pool_status(æ›´æ–°æ± å­çŠ¶æ€)collect_protocol_fee(æå–æ± å­ç´¯ç§¯çš„åè®®è´¹)123456789101112131415161718192021222324252627282930313233343536373839404142434445">
<meta property="og:type" content="article">
<meta property="og:title" content="swapé¡¹ç›®æ‹†è§£">
<meta property="og:url" content="https://just-gol.github.io/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/index.html">
<meta property="og:site_name" content="ä»Šæ—¥äº‹ä»Šæ—¥æ¯•">
<meta property="og:description" content="admincreate_amm_config(åˆ›å»º AMM é…ç½®)update_amm_config(æ›´æ–° AMM é…ç½®)update_pool_status(æ›´æ–°æ± å­çŠ¶æ€)collect_protocol_fee(æå–æ± å­ç´¯ç§¯çš„åè®®è´¹)123456789101112131415161718192021222324252627282930313233343536373839404142434445">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://just-gol.github.io/img/815c217a-ec50-48ef-8d79-30f543f553de.jpg">
<meta property="article:published_time" content="2025-08-25T11:53:19.000Z">
<meta property="article:modified_time" content="2025-08-25T11:54:12.473Z">
<meta property="article:author" content="Li">
<meta property="article:tag" content="Solana">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://just-gol.github.io/img/815c217a-ec50-48ef-8d79-30f543f553de.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "swapé¡¹ç›®æ‹†è§£",
  "url": "https://just-gol.github.io/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/",
  "image": "https://just-gol.github.io/img/815c217a-ec50-48ef-8d79-30f543f553de.jpg",
  "datePublished": "2025-08-25T11:53:19.000Z",
  "dateModified": "2025-08-25T11:54:12.473Z",
  "author": [
    {
      "@type": "Person",
      "name": "Li",
      "url": "https://just-gol.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://just-gol.github.io/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'swapé¡¹ç›®æ‹†è§£',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">ä»Šæ—¥äº‹ä»Šæ—¥æ¯•</span></a><a class="nav-page-title" href="/"><span class="site-name">swapé¡¹ç›®æ‹†è§£</span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">swapé¡¹ç›®æ‹†è§£</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-08-25T11:53:19.000Z" title="Created 2025-08-25 19:53:19">2025-08-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-25T11:54:12.473Z" title="Updated 2025-08-25 19:54:12">2025-08-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h2><h3 id="create-amm-config-åˆ›å»º-AMM-é…ç½®"><a href="#create-amm-config-åˆ›å»º-AMM-é…ç½®" class="headerlink" title="create_amm_config(åˆ›å»º AMM é…ç½®)"></a>create_amm_config(åˆ›å»º AMM é…ç½®)</h3><h3 id="update-amm-config-æ›´æ–°-AMM-é…ç½®"><a href="#update-amm-config-æ›´æ–°-AMM-é…ç½®" class="headerlink" title="update_amm_config(æ›´æ–° AMM é…ç½®)"></a>update_amm_config(æ›´æ–° AMM é…ç½®)</h3><h3 id="update-pool-status-æ›´æ–°æ± å­çŠ¶æ€"><a href="#update-pool-status-æ›´æ–°æ± å­çŠ¶æ€" class="headerlink" title="update_pool_status(æ›´æ–°æ± å­çŠ¶æ€)"></a>update_pool_status(æ›´æ–°æ± å­çŠ¶æ€)</h3><h3 id="collect-protocol-fee-æå–æ± å­ç´¯ç§¯çš„åè®®è´¹"><a href="#collect-protocol-fee-æå–æ± å­ç´¯ç§¯çš„åè®®è´¹" class="headerlink" title="collect_protocol_fee(æå–æ± å­ç´¯ç§¯çš„åè®®è´¹)"></a>collect_protocol_fee(æå–æ± å­ç´¯ç§¯çš„åè®®è´¹)</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collect_protocol_fee</span>(</span><br><span class="line">    ctx: Context&lt;CollectProtocolFee&gt;,</span><br><span class="line">    <span class="comment">// æå–åè®®æ‰‹ç»­è´¹çš„ä»£å¸0</span></span><br><span class="line">    amount_0_requested: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">// æå–åè®®æ‰‹ç»­è´¹çš„ä»£å¸1</span></span><br><span class="line">    amount_1_requested: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">amount_0</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">amount_1</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">auth_bump</span>: <span class="type">u8</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool_state</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pool_state.protocol_fees_token_0 æ± å­ä¸­å·²ç»ç´¯ç§¯çš„åè®®æ‰‹ç»­è´¹ä»£å¸0çš„æ•°é‡</span></span><br><span class="line">        <span class="comment">// å–æœ€å°åè®®æ‰‹ç»­è´¹</span></span><br><span class="line">        amount_0 = amount_0_requested.<span class="title function_ invoke__">min</span>(pool_state.protocol_fees_token_0);</span><br><span class="line">        amount_1 = amount_1_requested.<span class="title function_ invoke__">min</span>(pool_state.protocol_fees_token_1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ± ä¸­å‰©ä½™æœªæå–åè®®æ‰‹ç»­è´¹ token0</span></span><br><span class="line">        pool_state.protocol_fees_token_0 = pool_state</span><br><span class="line">            .protocol_fees_token_0</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(amount_0)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        pool_state.protocol_fees_token_1 = pool_state</span><br><span class="line">            .protocol_fees_token_1</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(amount_1)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        auth_bump = pool_state.auth_bump;</span><br><span class="line">        pool_state.recent_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç”¨æ± å­æˆæƒçš„èº«ä»½ï¼Œä»æ± å­ä»£å¸0æ‰˜ç®¡è´¦æˆ·æŠŠæ‰‹ç»­è´¹ä»£å¸è½¬åˆ°æ”¶æ¬¾äººçš„è´¦æˆ·</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">         <span class="comment">// æˆæƒè€…è´¦æˆ·ï¼ˆç­¾åè€…ï¼‰</span></span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">         <span class="comment">// æ± å­ä¸­æ‰˜ç®¡ä»£å¸0çš„è´¦æˆ·ï¼ˆvaultï¼‰</span></span><br><span class="line">        ctx.accounts.token_0_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="comment">// æ¥æ”¶è€…çš„ä»£å¸0è´¦æˆ·</span></span><br><span class="line">        ctx.accounts.recipient_token_0_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">         <span class="comment">// ä»£å¸0çš„Mintè´¦æˆ·ï¼ˆç”¨äºéªŒè¯å’Œdecimalsï¼‰</span></span><br><span class="line">        <span class="comment">// é€šè¿‡è¯»å–è¯¥è´¦æˆ·çš„æ•°æ®ç»“æ„ï¼Œç¡®è®¤ä»£å¸ä¿¡æ¯å’Œæœ‰æ•ˆæ€§</span></span><br><span class="line">        ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">         <span class="comment">// æ ¹æ®mintçš„æ‹¥æœ‰è€…é€‰æ‹©tokenç¨‹åºç‰ˆæœ¬ï¼ˆv1æˆ–v2ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// è½¬è´¦çš„ä»£å¸0æ•°é‡</span></span><br><span class="line">        amount_0,</span><br><span class="line">        <span class="comment">// PDAçš„ç§å­å’Œbumpï¼Œç”¨äºæƒé™ç­¾å</span></span><br><span class="line">        ctx.accounts.vault_0_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_1_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.recipient_token_1_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        amount_1,</span><br><span class="line">        ctx.accounts.vault_1_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>collect_fund_feeå’Œcollect_protocol_fee ä¸€æ ·</p>
</blockquote>
<ul>
<li><code>protocol_fees</code> æ˜¯ç»™åè®®æ–¹ï¼ˆå›¢é˜Ÿã€æ²»ç†ï¼‰çš„æ‰‹ç»­è´¹ã€‚</li>
<li><code>fund_fees</code>  ç»™é¡¹ç›®çš„â€œåŸºé‡‘â€æˆ–è€…â€œå¥–åŠ±æ± â€ï¼Œç”¨äºæ¯”å¦‚ç»™æµåŠ¨æ€§æä¾›è€…å‘å¥–åŠ±ï¼Œæˆ–è€…åšç¤¾åŒºæ´»åŠ¨ç»è´¹ã€‚</li>
</ul>
<h4 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h4><p>ä½ å»å•†åº—ä¹°ä¸œè¥¿ï¼š</p>
<ul>
<li>å•†åº—ä¼šæ”¶ä¸€å®šçš„æœåŠ¡è´¹ï¼ˆæ‰‹ç»­è´¹ï¼‰ã€‚</li>
<li>è¿™ç¬”æœåŠ¡è´¹åˆ†ä¸¤éƒ¨åˆ†ï¼š<ul>
<li>ä¸€éƒ¨åˆ†ç»™å•†åº—è€æ¿ï¼ˆåè®®è´¹ç”¨ï¼‰</li>
<li>ä¸€éƒ¨åˆ†æ”¾åˆ°â€œå‘˜å·¥å¥–åŠ±åŸºé‡‘â€æˆ–è€…â€œå•†åº—æ”¹å–„åŸºé‡‘â€ï¼ˆåŸºé‡‘è´¹ç”¨ï¼‰</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥åœ¨ä»£ç é‡Œï¼š</p>
<ul>
<li><code>protocol_fees_token_0</code> å°±æ˜¯å•†åº—è€æ¿é‚£éƒ¨åˆ†çš„é’±ã€‚</li>
<li><code>fund_fees_token_0</code> å°±æ˜¯æ”¾åˆ°å¥–åŠ±åŸºé‡‘é‡Œçš„é’±ã€‚</li>
</ul>
<p>ä¸¤éƒ¨åˆ†éƒ½å­˜åœ¨æ± å­é‡Œï¼Œåˆ†åˆ«è®°å½•ï¼Œç­‰ç€æœ‰äººæ¥â€œæç°â€æˆ–è€…åˆ†å‘ã€‚</p>
<h3 id="collect-fund-fee-æå–æ± å­ç´¯ç§¯çš„èµ„é‡‘è´¹ç”¨"><a href="#collect-fund-fee-æå–æ± å­ç´¯ç§¯çš„èµ„é‡‘è´¹ç”¨" class="headerlink" title="collect_fund_fee(æå–æ± å­ç´¯ç§¯çš„èµ„é‡‘è´¹ç”¨)"></a>collect_fund_fee(æå–æ± å­ç´¯ç§¯çš„èµ„é‡‘è´¹ç”¨)</h3><h2 id="User"><a href="#User" class="headerlink" title="User"></a>User</h2><h3 id="initialize-åˆ›å»ºæµåŠ¨æ€§"><a href="#initialize-åˆ›å»ºæµåŠ¨æ€§" class="headerlink" title="initialize(åˆ›å»ºæµåŠ¨æ€§)"></a>initialize(åˆ›å»ºæµåŠ¨æ€§)</h3><h4 id="Initializeç»“æ„ä½“å­—æ®µ"><a href="#Initializeç»“æ„ä½“å­—æ®µ" class="headerlink" title="Initializeç»“æ„ä½“å­—æ®µ"></a>Initializeç»“æ„ä½“å­—æ®µ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Initialize</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Address paying to create the pool. Can be anyone</span></span><br><span class="line">    <span class="comment">// æ± å­çš„åˆ›å»ºè€…(ä½ çš„é’±åŒ…è´¦æˆ·)</span></span><br><span class="line">    <span class="comment">// æ”¯ä»˜åˆå§‹åŒ–æ± å­çš„è´¹ç”¨,æä¾›åˆå§‹æµåŠ¨æ€§</span></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> creator: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Which config the pool belongs to.</span></span><br><span class="line">    <span class="comment">// æ± å­æ‰€å±çš„AMMé…ç½®(ä¾‹å¦‚æ‰‹ç»­è´¹ç‡,æ˜¯å¦å…è®¸åˆ›å»ºç­‰)</span></span><br><span class="line">    <span class="keyword">pub</span> amm_config: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, AmmConfig&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK:</span></span><br><span class="line">    <span class="comment">/// pool vault and lp mint authority</span></span><br><span class="line">    <span class="comment">// æ± å­çš„PDAæˆæƒåœ°å€,åç»­ç”¨äºæ§åˆ¶lp_mintå’Œvaultè´¦æˆ·</span></span><br><span class="line">    <span class="comment">// é€šå¸¸æ˜¯ä½¿ç”¨ç§å­AUTH_SEEDç”Ÿæˆçš„PDA(ç¨‹åºæ´¾ç”Ÿåœ°å€)</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: Initialize an account to store the pool state</span></span><br><span class="line">    <span class="comment">/// PDA account:</span></span><br><span class="line">    <span class="comment">/// seeds = [</span></span><br><span class="line">    <span class="comment">/// Â  Â  POOL_SEED.as_bytes(),</span></span><br><span class="line">    <span class="comment">/// Â  Â  amm_config.key().as_ref(),</span></span><br><span class="line">    <span class="comment">/// Â  Â  token_0_mint.key().as_ref(),</span></span><br><span class="line">    <span class="comment">/// Â  Â  token_1_mint.key().as_ref(),</span></span><br><span class="line">    <span class="comment">/// ],</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Or random account: must be signed by cli</span></span><br><span class="line">    <span class="comment">// å­˜å‚¨æ± å­çš„ä¸»è¦çŠ¶æ€ä¿¡æ¯:ä¾‹å¦‚å½“å‰æµåŠ¨æ€§,ç´¯ç§¯æ‰‹ç»­è´¹ç­‰</span></span><br><span class="line">    <span class="comment">// åç»­ä½ å®šä¹‰çš„PoolStateå°±ä¼šå­˜åœ¨è¿™ä¸ªåœ°å€ä¸Š</span></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Token_0 mint, the key must smaller than token_1 mint.</span></span><br><span class="line">    <span class="comment">// Token_0 mintï¼Œå¿…é¡»å°äº token_1_mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        constraint = token_0_mint.key() &lt; token_1_mint.key(),</span></span><br><span class="line"><span class="meta">        mint::token_program = token_0_program,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Token_1 mint, the key must grater then token_0 mint.</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºçš„æ± å­æ˜¯ token0/token1 çš„äº¤æ˜“å¯¹ã€‚</span></span><br><span class="line">    <span class="comment">// å¿…é¡»æŒ‰ç…§åœ°å€å¤§å°æ’åºï¼ˆä¸ºäº†ç¡®ä¿æ± å­å”¯ä¸€æ€§ï¼Œé¿å… token0=A token1=B å’Œ A/Bã€B/A æ˜¯ä¸¤ä¸ªæ± ï¼‰ã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mint::token_program = token_1_program,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// pool lp mint</span></span><br><span class="line">    <span class="comment">//  LPï¼ˆæµåŠ¨æ€§æä¾›è€…ï¼‰Token ç›¸å…³</span></span><br><span class="line">    <span class="comment">// LP Token çš„ mint è´¦æˆ·ï¼šç”¨äºä»£è¡¨ä½ æä¾›çš„æµåŠ¨æ€§ä»½é¢ã€‚</span></span><br><span class="line">    <span class="comment">// æ§åˆ¶æƒå±äºä¸Šé¢çš„ authority PDAã€‚</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ—¶ç”± creator æ”¯ä»˜ç§Ÿé‡‘ã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            POOL_LP_MINT_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        mint::decimals = <span class="number">9</span>,</span><br><span class="line">        mint::authority = authority,</span><br><span class="line">        payer = creator,</span><br><span class="line">        mint::token_program = token_program,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> lp_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// payer token0 account</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºè€…æä¾›çš„åˆå§‹ token0 å’Œ token1ã€‚</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ—¶ä¼šä»è¿™ä¸¤ä¸ªè´¦æˆ·è½¬ç§»åˆå§‹èµ„é‡‘åˆ°æ± å­ vaultã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        token::mint = token_0_mint,</span></span><br><span class="line"><span class="meta">        token::authority = creator,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> creator_token_0: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// creator token1 account</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        token::mint = token_1_mint,</span></span><br><span class="line"><span class="meta">        token::authority = creator,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> creator_token_1: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// creator lp token account</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºè€…æ¥æ”¶ LP token çš„åœ°å€ã€‚</span></span><br><span class="line">    <span class="comment">// ä¼š mint liquidity - lock_lp_amount ä¸ª LP token åˆ°è¿™é‡Œã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        associated_token::mint = lp_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = creator,</span></span><br><span class="line"><span class="meta">        payer = creator,</span></span><br><span class="line"><span class="meta">        token::token_program = token_program,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> creator_lp_token: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: Token_0 vault for the pool, created by contract</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            POOL_VAULT_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">            token_0_mint.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: Token_1 vault for the pool, created by contract</span></span><br><span class="line">    <span class="comment">//  æ± å­çš„æ‰˜ç®¡è´¦æˆ·ï¼ˆvaultï¼‰</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ªæ± å­éƒ½æœ‰ä¸¤ä¸ª vaultï¼Œæ‰˜ç®¡ token0 å’Œ token1ã€‚</span></span><br><span class="line">    <span class="comment">// ç”± authority PDA æ§åˆ¶ã€‚</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ—¶ç”±ç¨‹åºé€šè¿‡ create_token_account åˆ›å»ºã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            POOL_VAULT_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">            token_1_mint.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> token_1_vault: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// create pool fee account</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ± å­çš„è´¹ç”¨æ”¶æ¬¾åœ°å€</span></span><br><span class="line">    <span class="comment">// å¦‚æœåè®®è®¾ç½®äº†åˆ›å»ºæ± å­çš„æ‰‹ç»­è´¹ï¼Œè¿™ä¸ªè´¦æˆ·å°±æ˜¯æ”¶æ¬¾è´¦æˆ·ã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        address= crate::create_pool_fee_reveiver::ID,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> create_pool_fee: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// an account to store oracle observations</span></span><br><span class="line">    <span class="comment">// Oracle / ä»·æ ¼è§‚æµ‹çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// ç”¨äºè®°å½•æ± å­ä»·æ ¼è½¨è¿¹çš„çŠ¶æ€è´¦æˆ·ã€‚</span></span><br><span class="line">    <span class="comment">// åç»­åš TWAPï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼‰ç­‰éœ€è¦ä¾èµ–å®ƒã€‚</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            OBSERVATION_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        payer = creator,</span><br><span class="line">        space = ObservationState::LEN</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> observation_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, ObservationState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Program to create mint account and mint tokens</span></span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="comment">/// Spl token program or token program 2022</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line">    <span class="comment">/// Spl token program or token program 2022</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line">    <span class="comment">/// Program to create an ATA for receiving position NFT</span></span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="comment">/// To create a new program account</span></span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="comment">/// Sysvar for program account</span></span><br><span class="line">    <span class="keyword">pub</span> rent: Sysvar&lt;<span class="symbol">&#x27;info</span>, Rent&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ä½œç”¨</th>
<th>å­—æ®µå</th>
</tr>
</thead>
<tbody><tr>
<td>é’±ã€æƒé™</td>
<td><code>creator</code>, <code>authority</code></td>
</tr>
<tr>
<td>é…ç½®&amp;çŠ¶æ€</td>
<td><code>amm_config</code>, <code>pool_state</code></td>
</tr>
<tr>
<td>ä»£å¸ Mint ä¿¡æ¯</td>
<td><code>token_0_mint</code>, <code>token_1_mint</code>, <code>lp_mint</code></td>
</tr>
<tr>
<td>åˆ›å»ºè€…èµ„äº§è´¦æˆ·</td>
<td><code>creator_token_0</code>, <code>creator_token_1</code>, <code>creator_lp_token</code></td>
</tr>
<tr>
<td>æ± æ‰˜ç®¡èµ„äº§è´¦æˆ·</td>
<td><code>token_0_vault</code>, <code>token_1_vault</code></td>
</tr>
<tr>
<td>è´¹ç”¨å’Œè§‚æµ‹è¾…åŠ©</td>
<td><code>create_pool_fee</code>, <code>observation_state</code></td>
</tr>
<tr>
<td>ç³»ç»Ÿä¾èµ–</td>
<td><code>token_program</code>, <code>system_program</code> ç­‰</td>
</tr>
</tbody></table>
<h4 id="å‡½æ•°ç­¾åå’Œå‚æ•°"><a href="#å‡½æ•°ç­¾åå’Œå‚æ•°" class="headerlink" title="å‡½æ•°ç­¾åå’Œå‚æ•°"></a>å‡½æ•°ç­¾åå’Œå‚æ•°</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">initialize</span>(</span><br><span class="line">    ctx: Context&lt;Initialize&gt;,</span><br><span class="line">    init_amount_0: <span class="type">u64</span>,</span><br><span class="line">    init_amount_1: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">mut</span> open_time: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ctx</code>: Anchor ä¼ å…¥çš„è´¦æˆ·ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ‰€æœ‰è´¦æˆ·ï¼‰</li>
<li><code>init_amount_0 / init_amount_1</code>: åˆ›å»ºè€…æŠ•å…¥çš„åˆå§‹ token0 å’Œ token1 æ•°é‡</li>
<li><code>open_time</code>: æ± å­çš„å¼€æ”¾æ—¶é—´æˆ³ï¼ˆUnixæ—¶é—´ï¼Œç§’ï¼‰</li>
</ul>
<hr>
<h4 id="ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ-mint-æ˜¯å¦å—æ”¯æŒ"><a href="#ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ-mint-æ˜¯å¦å—æ”¯æŒ" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ mint æ˜¯å¦å—æ”¯æŒ"></a>ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ mint æ˜¯å¦å—æ”¯æŒ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> !(<span class="title function_ invoke__">is_supported_mint</span>(&amp;ctx.accounts.token_0_mint).<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">     &amp;&amp; <span class="title function_ invoke__">is_supported_mint</span>(&amp;ctx.accounts.token_1_mint).<span class="title function_ invoke__">unwrap</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> err!(ErrorCode::NotSupportMint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç›®çš„ï¼š"><a href="#ç›®çš„ï¼š" class="headerlink" title="ç›®çš„ï¼š"></a>ç›®çš„ï¼š</h5><ul>
<li>é˜²æ­¢æ¶æ„æˆ–ä¸åˆè§„çš„ mint è¢«ç”¨äºå»ºæ± ï¼ˆæ¯”å¦‚åŒ…å«ç¦æ­¢è½¬è´¦ç­‰ extensionï¼‰</li>
<li><code>is_supported_mint()</code> ä¼šæ£€æŸ¥ï¼š<ul>
<li>æ˜¯æ ‡å‡† SPL token</li>
<li>æˆ–æ˜¯å…è®¸çš„ Token 2022 mintï¼ˆç™½åå• + extension æ ¡éªŒï¼‰</li>
</ul>
</li>
</ul>
<hr>
<h4 id="ç¬¬äºŒæ­¥ï¼šæ˜¯å¦å…è®¸å»ºæ± "><a href="#ç¬¬äºŒæ­¥ï¼šæ˜¯å¦å…è®¸å»ºæ± " class="headerlink" title="ç¬¬äºŒæ­¥ï¼šæ˜¯å¦å…è®¸å»ºæ± "></a>ç¬¬äºŒæ­¥ï¼šæ˜¯å¦å…è®¸å»ºæ± </h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> ctx.accounts.amm_config.disable_create_pool &#123;</span><br><span class="line">    <span class="keyword">return</span> err!(ErrorCode::NotApproved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹³å°æ–¹å¯ä»¥é€šè¿‡ <code>AmmConfig</code> é…ç½®é¡¹å…¨å±€å…³é—­å»ºæ± åŠŸèƒ½ï¼ˆé˜²æ­¢ç”¨æˆ·ç§è‡ªåˆ›å»ºæ± å­ï¼‰ã€‚</p>
<hr>
<h4 id="ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´å¼€æ”¾æ—¶é—´-open-time"><a href="#ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´å¼€æ”¾æ—¶é—´-open-time" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´å¼€æ”¾æ—¶é—´ open_time"></a>ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´å¼€æ”¾æ—¶é—´ open_time</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">block_timestamp</span> = clock::Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp <span class="keyword">as</span> <span class="type">u64</span>;</span><br><span class="line"><span class="keyword">if</span> open_time &lt;= block_timestamp &#123;</span><br><span class="line">    open_time = block_timestamp + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¡®ä¿ <code>open_time</code> ä¸æ—©äºå½“å‰æ—¶é—´ï¼Œé¿å…é€»è¾‘é”™è¯¯ï¼ˆå¦‚ç«‹å³å¼€æ”¾è¢«è·³è¿‡ï¼‰ã€‚</p>
<hr>
<h4 id="ç¬¬å››æ­¥ï¼šä¸ºæ± åˆ›å»º-2-ä¸ª-vault-è´¦æˆ·"><a href="#ç¬¬å››æ­¥ï¼šä¸ºæ± åˆ›å»º-2-ä¸ª-vault-è´¦æˆ·" class="headerlink" title="ç¬¬å››æ­¥ï¼šä¸ºæ± åˆ›å»º 2 ä¸ª vault è´¦æˆ·"></a>ç¬¬å››æ­¥ï¼šä¸ºæ± åˆ›å»º 2 ä¸ª vault è´¦æˆ·</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">create_token_account</span>(... token_0_vault ...)</span><br><span class="line"><span class="title function_ invoke__">create_token_account</span>(... token_1_vault ...)</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª vault æ˜¯ä¸€ä¸ªæ‰˜ç®¡è´¦æˆ·ï¼Œç”¨äºå­˜æ”¾ LP ç”¨æˆ·çš„ token0 &#x2F; token1ã€‚å…¶ owner æ˜¯ç¨‹åº PDAï¼Œå³ä¸èƒ½è¢«ç”¨æˆ·ç§è‡ªæ“ä½œã€‚</p>
<p>ğŸ“Œ PDA æ„é€ æ–¹å¼ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[POOL_VAULT_SEED, pool_state.<span class="title function_ invoke__">key</span>(), token_x_mint.<span class="title function_ invoke__">key</span>()]</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¼ å…¥ <code>bump</code> ä¿è¯åœ°å€å”¯ä¸€æ€§ã€‚</p>
<hr>
<h4 id="ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ± çŠ¶æ€è´¦æˆ·-pool-state"><a href="#ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ± çŠ¶æ€è´¦æˆ·-pool-state" class="headerlink" title="ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ± çŠ¶æ€è´¦æˆ· pool_state"></a>ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ± çŠ¶æ€è´¦æˆ· pool_state</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">pool_state_loader</span> = <span class="title function_ invoke__">create_pool</span>(...);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">pool_state</span> = &amp;<span class="keyword">mut</span> pool_state_loader.<span class="title function_ invoke__">load_init</span>()?;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè´¦æˆ·è®°å½• AMM çš„å…¨å±€çŠ¶æ€ï¼šå¦‚ vault åœ°å€ã€æµåŠ¨æ€§å¤§å°ã€LP mintã€å…¬å¹³å¼€ç›˜æ—¶é—´ç­‰ã€‚</p>
<p>ğŸ“Œ åœ°å€å¯èƒ½æ˜¯ PDAï¼Œä¹Ÿå¯èƒ½æ˜¯ CLI æŒ‡å®šçš„ signer åœ°å€ã€‚</p>
<hr>
<h4 id="ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–-observation-çŠ¶æ€ï¼ˆè®°å½•ä»·æ ¼ä¿¡æ¯ï¼‰"><a href="#ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–-observation-çŠ¶æ€ï¼ˆè®°å½•ä»·æ ¼ä¿¡æ¯ï¼‰" class="headerlink" title="ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ– observation çŠ¶æ€ï¼ˆè®°å½•ä»·æ ¼ä¿¡æ¯ï¼‰"></a>ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ– observation çŠ¶æ€ï¼ˆè®°å½•ä»·æ ¼ä¿¡æ¯ï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">observation_state</span> = ctx.accounts.observation_state.<span class="title function_ invoke__">load_init</span>()?;</span><br><span class="line">observation_state.pool_id = ctx.accounts.pool_state.<span class="title function_ invoke__">key</span>();</span><br></pre></td></tr></table></figure>

<p>ç”¨äºè®°å½• TWAPï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼‰æˆ–åš oracle æœåŠ¡ç­‰ç”¨é€”ã€‚</p>
<hr>
<h4 id="ç¬¬ä¸ƒæ­¥ï¼šè½¬å…¥åˆå§‹-token-åˆ°-vault"><a href="#ç¬¬ä¸ƒæ­¥ï¼šè½¬å…¥åˆå§‹-token-åˆ°-vault" class="headerlink" title="ç¬¬ä¸ƒæ­¥ï¼šè½¬å…¥åˆå§‹ token åˆ° vault"></a>ç¬¬ä¸ƒæ­¥ï¼šè½¬å…¥åˆå§‹ token åˆ° vault</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(... init_amount_0 ...)</span><br><span class="line"><span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(... init_amount_1 ...)</span><br></pre></td></tr></table></figure>

<p>ä»åˆ›å»ºè€…çš„ token è´¦æˆ·ä¸­è½¬å‡º init_amount_0 å’Œ init_amount_1 åˆ°åˆšåˆšåˆ›å»ºçš„ vault ä¸­ã€‚</p>
<p>ğŸ“Œ è¿™é‡Œå®é™…æ˜¯è°ƒç”¨äº† <code>spl_token::transfer</code> CPIã€‚</p>
<hr>
<h4 id="ç¬¬å…«æ­¥ï¼šä»-vault-è´¦æˆ·ä¸­è¯»å–ä½™é¢ï¼ŒéªŒè¯åˆå§‹-token-æ•°é‡æ˜¯å¦åˆç†"><a href="#ç¬¬å…«æ­¥ï¼šä»-vault-è´¦æˆ·ä¸­è¯»å–ä½™é¢ï¼ŒéªŒè¯åˆå§‹-token-æ•°é‡æ˜¯å¦åˆç†" class="headerlink" title="ç¬¬å…«æ­¥ï¼šä» vault è´¦æˆ·ä¸­è¯»å–ä½™é¢ï¼ŒéªŒè¯åˆå§‹ token æ•°é‡æ˜¯å¦åˆç†"></a>ç¬¬å…«æ­¥ï¼šä» vault è´¦æˆ·ä¸­è¯»å–ä½™é¢ï¼ŒéªŒè¯åˆå§‹ token æ•°é‡æ˜¯å¦åˆç†</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">token_0_vault</span> = <span class="title function_ invoke__">unpack</span>(token_0_vault_account)</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">token_1_vault</span> = <span class="title function_ invoke__">unpack</span>(token_1_vault_account)</span><br><span class="line"></span><br><span class="line">        CurveCalculator::<span class="title function_ invoke__">validate_supply</span>(token_0_vault.amount, token_1_vault.amount)?;</span><br></pre></td></tr></table></figure>

<p>å¹³å°å¯èƒ½é™åˆ¶åˆå§‹æµåŠ¨æ€§æ¯”ä¾‹ï¼Œæ¯”å¦‚ token0 : token1 å¿…é¡»ç­‰å€¼ï¼Œé¿å…åˆ›å»ºä¸å¹³è¡¡æ± ã€‚</p>
<hr>
<h4 id="ç¬¬ä¹æ­¥ï¼šè®¡ç®—åˆå§‹-LP-token-çš„æ•°é‡ï¼ˆæµåŠ¨æ€§ï¼‰"><a href="#ç¬¬ä¹æ­¥ï¼šè®¡ç®—åˆå§‹-LP-token-çš„æ•°é‡ï¼ˆæµåŠ¨æ€§ï¼‰" class="headerlink" title="ç¬¬ä¹æ­¥ï¼šè®¡ç®—åˆå§‹ LP token çš„æ•°é‡ï¼ˆæµåŠ¨æ€§ï¼‰"></a>ç¬¬ä¹æ­¥ï¼šè®¡ç®—åˆå§‹ LP token çš„æ•°é‡ï¼ˆæµåŠ¨æ€§ï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">liquidity</span> = <span class="title function_ invoke__">sqrt</span>(amount_0 * amount_1)</span><br><span class="line"><span class="keyword">let</span> <span class="variable">lock_lp_amount</span> = <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>Uniswap v2 çš„æ–¹å¼ï¼Œç”¨ âˆš(token0 * token1) è®¡ç®—æµåŠ¨æ€§ï¼Œç„¶åï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mint_to</span>(</span><br><span class="line">    mint: lp_mint,</span><br><span class="line">    to: creator_lp_token,</span><br><span class="line">    amount: liquidity - lock_lp_amount,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>Mint å‡º LP token ç»™åˆ›å»ºè€…ï¼Œç”¨äºä»£è¡¨å…¶è´¡çŒ®çš„æµåŠ¨æ€§</li>
<li>é”ä»“ä¸€å°éƒ¨åˆ† LP tokenï¼Œé˜²æ­¢æµåŠ¨æ€§å®Œå…¨ä¸º 0ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰</li>
</ul>
<hr>
<h4 id="ç¬¬åæ­¥ï¼šæ‰£é™¤åˆ›å»ºæ± æ‰‹ç»­è´¹ï¼ˆå¦‚æœé…ç½®æœ‰ï¼‰"><a href="#ç¬¬åæ­¥ï¼šæ‰£é™¤åˆ›å»ºæ± æ‰‹ç»­è´¹ï¼ˆå¦‚æœé…ç½®æœ‰ï¼‰" class="headerlink" title="ç¬¬åæ­¥ï¼šæ‰£é™¤åˆ›å»ºæ± æ‰‹ç»­è´¹ï¼ˆå¦‚æœé…ç½®æœ‰ï¼‰"></a>ç¬¬åæ­¥ï¼šæ‰£é™¤åˆ›å»ºæ± æ‰‹ç»­è´¹ï¼ˆå¦‚æœé…ç½®æœ‰ï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> ctx.accounts.amm_config.create_pool_fee != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(<span class="title function_ invoke__">transfer</span>(...));</span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(<span class="title function_ invoke__">sync_native</span>(...));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç³»ç»Ÿä» <code>creator</code> è½¬è´¦ SOL åˆ°å¹³å°æ”¶æ¬¾è´¦æˆ· <code>create_pool_fee</code></li>
<li>ç„¶åè°ƒç”¨ <code>sync_native</code> è®©è¯¥ token account æ˜¾ç¤ºæ›´æ–°åçš„ä½™é¢ï¼ˆToken 2022 çš„ç‰¹æ€§ï¼‰</li>
</ul>
<hr>
<h4 id="ç¬¬åä¸€æ­¥ï¼šåˆå§‹åŒ–-pool-state-å†…å®¹"><a href="#ç¬¬åä¸€æ­¥ï¼šåˆå§‹åŒ–-pool-state-å†…å®¹" class="headerlink" title="ç¬¬åä¸€æ­¥ï¼šåˆå§‹åŒ– pool_state å†…å®¹"></a>ç¬¬åä¸€æ­¥ï¼šåˆå§‹åŒ– pool_state å†…å®¹</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pool_state.<span class="title function_ invoke__">initialize</span>(</span><br><span class="line">    ctx.bumps.authority,</span><br><span class="line">    liquidity,</span><br><span class="line">    open_time,</span><br><span class="line">    ctx.accounts.creator.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">    ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>æŠŠè¿™ä¸ªæ± çš„æ‰€æœ‰ä¿¡æ¯åˆå§‹åŒ–å†™å…¥ pool_stateï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>token_0_vault</code></li>
<li><code>token_1_vault</code></li>
<li><code>lp_mint</code></li>
<li><code>observation_state</code></li>
<li><code>creator</code></li>
<li><code>open_time</code></li>
<li><code>auth_bump</code></li>
</ul>
<hr>
<h4 id="è¿”å›æˆåŠŸ"><a href="#è¿”å›æˆåŠŸ" class="headerlink" title="è¿”å›æˆåŠŸ"></a>è¿”å›æˆåŠŸ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Ok</span>(())</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹æ•°æ®æµåŠ¨-çŠ¶æ€å˜æ›´"><a href="#æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹æ•°æ®æµåŠ¨-çŠ¶æ€å˜æ›´" class="headerlink" title="æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹æ•°æ®æµåŠ¨ &amp; çŠ¶æ€å˜æ›´"></a>æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹æ•°æ®æµåŠ¨ &amp; çŠ¶æ€å˜æ›´</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">init -&gt; â”‚ creator     â”‚  token0 &amp; token1</span><br><span class="line">        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ transfer to token_x_vaultâ”‚  (æ‰˜ç®¡è´¦æˆ·, PDA)</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ LP mint (âˆšx*y)          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ creator_lp_token        â”‚ â† åˆ†å‘ LP token</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">             â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ pool_state åˆå§‹åŒ–        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>



<h4 id="AMMåˆå§‹åŒ–è´¦æˆ·é¡¸å›¾"><a href="#AMMåˆå§‹åŒ–è´¦æˆ·é¡¸å›¾" class="headerlink" title="AMMåˆå§‹åŒ–è´¦æˆ·é¡¸å›¾"></a>AMMåˆå§‹åŒ–è´¦æˆ·é¡¸å›¾</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">           â”‚  creator     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">           â”‚  (ç­¾åè€…)    â”‚             â”‚</span><br><span class="line">           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚</span><br><span class="line">                 â”‚                      â”‚payer</span><br><span class="line">        æä¾›åˆå§‹Token                  â–¼</span><br><span class="line">     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">     â”‚creator_token_0â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ token_0_vault   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚</span><br><span class="line">     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚æ§åˆ¶æƒ</span><br><span class="line">     â”‚creator_token_1â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ token_1_vault   â”‚â—„â”€â”€â”€â”€â”  â”‚</span><br><span class="line">     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚</span><br><span class="line">                                                  â–¼  â–¼  â”‚</span><br><span class="line">                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                                             â”‚ <span class="title function_ invoke__">authority</span> (PDA) â”‚</span><br><span class="line">                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                                                    â”‚</span><br><span class="line">                    æ§åˆ¶ mint LP Token               â–¼</span><br><span class="line">                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                                      â”‚   <span class="title function_ invoke__">lp_mint</span> (æ± å­LPä»£å¸) â”‚</span><br><span class="line">                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                                                 â”‚</span><br><span class="line">                         mint åˆ°                 â–¼</span><br><span class="line">                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                                      â”‚ creator_lp_token       â”‚</span><br><span class="line">                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">é…ç½®:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ amm_config        â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">çŠ¶æ€:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ pool_state        â”‚â—„â”€â”€â”€â”€init åˆ›å»º</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">ä»·æ ¼è§‚æµ‹:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ observation_state      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">å¯é€‰è´¹ç”¨æ”¶æ¬¾åœ°å€:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ create_pool_fee            â”‚â—„â”€â”€â”€â”€â”€â”€ system_instruction::transfer</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br><span class="line">ä¾èµ–ç¨‹åº:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚ token_program / system_program ç­‰ â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>authority</code> æ˜¯ PDAï¼Œç”±ç¨‹åºç”Ÿæˆï¼Œæ§åˆ¶ vault å’Œ LP mintã€‚</li>
<li><code>creator</code> æ˜¯æä¾›èµ„é‡‘å¹¶åˆå§‹åŒ–æ± å­çš„ç”¨æˆ·ã€‚</li>
<li>åˆå§‹ token0 å’Œ token1 ä» <code>creator_token_*</code> è½¬å…¥ vaultã€‚</li>
<li>LP token è¢« mint åˆ° <code>creator_lp_token</code>ã€‚</li>
<li><code>pool_state</code> æ˜¯æ± å­çš„ä¸»çŠ¶æ€ï¼ŒåŒ…å«æ‰€æœ‰ä¿¡æ¯ã€‚</li>
<li><code>observation_state</code> æ˜¯ TWAP ä½¿ç”¨çš„ Oracle çŠ¶æ€ã€‚</li>
<li><code>create_pool_fee</code> æ˜¯åè®®æ”¶æ‰‹ç»­è´¹çš„ TokenAccountï¼ˆå¯ä»¥æ˜¯ SOL æˆ– WSOLï¼‰ã€‚</li>
</ul>
<h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><h5 id="token-0-mintä¸ºä»€ä¹ˆæ¯”token-1-mintå°"><a href="#token-0-mintä¸ºä»€ä¹ˆæ¯”token-1-mintå°" class="headerlink" title="token_0_mintä¸ºä»€ä¹ˆæ¯”token_1_mintå°"></a>token_0_mintä¸ºä»€ä¹ˆæ¯”token_1_mintå°</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Token_0 mint, the key must smaller than token_1 mint.</span></span><br><span class="line"><span class="meta">#[account(</span></span><br><span class="line"><span class="meta">    constraint = token_0_mint.key() &lt; token_1_mint.key(),</span></span><br><span class="line"><span class="meta">    mint::token_program = token_0_program,</span></span><br><span class="line"><span class="meta">)]</span></span><br><span class="line"><span class="keyword">pub</span> token_0_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Token_1 mint, the key must grater then token_0 mint.</span></span><br><span class="line"><span class="meta">#[account(</span></span><br><span class="line"><span class="meta">    mint::token_program = token_1_program,</span></span><br><span class="line"><span class="meta">)]</span></span><br><span class="line"><span class="keyword">pub</span> token_1_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br></pre></td></tr></table></figure>

<p><code>token_0</code> å¿…é¡»æ¯” <code>token_1</code> å°ï¼Œæ˜¯ä¸ºäº†ï¼š</p>
<ol>
<li>ä¿è¯ <strong>äº¤æ˜“å¯¹å”¯ä¸€æ€§</strong>ï¼ˆä¸é‡å¤å»ºæ± ï¼‰ã€‚</li>
<li>ç®€åŒ–é€»è¾‘ï¼Œé¿å…é¡ºåºæ­§ä¹‰ã€‚</li>
<li>ä¿è¯æ± å­ PDA&#x2F;åœ°å€ç”Ÿæˆçš„ä¸€è‡´æ€§ã€‚</li>
</ol>
<h5 id="ä¸ºä»€ä¹ˆsigner-seedsä¸ºä»€ä¹ˆæ˜¯token-1-vault"><a href="#ä¸ºä»€ä¹ˆsigner-seedsä¸ºä»€ä¹ˆæ˜¯token-1-vault" class="headerlink" title="ä¸ºä»€ä¹ˆsigner_seedsä¸ºä»€ä¹ˆæ˜¯token_1_vault"></a>ä¸ºä»€ä¹ˆsigner_seedsä¸ºä»€ä¹ˆæ˜¯token_1_vault</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_token_account</span>(</span><br><span class="line">    &amp;ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;ctx.accounts.creator.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;ctx.accounts.token_1_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;ctx.accounts.token_1_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;ctx.accounts.system_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;ctx.accounts.token_1_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &amp;[</span><br><span class="line">        POOL_VAULT_SEED.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        ctx.accounts.pool_state.<span class="title function_ invoke__">key</span>().<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        ctx.accounts.token_1_mint.<span class="title function_ invoke__">key</span>().<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.token_1_vault][..],</span><br><span class="line">    ],</span><br><span class="line">)?;</span><br></pre></td></tr></table></figure>

<p> ä¹‹æ‰€ä»¥ç”¨ <code>token_0_vault</code> åšç­¾åï¼Œæ˜¯å› ä¸º <strong>å®ƒå°±æ˜¯è¢«åˆ›å»ºçš„é‚£ä¸ªè´¦æˆ·</strong>ï¼Œç³»ç»Ÿè¦æ±‚â€œæ–°è´¦æˆ·è‡ªå·±å¿…é¡»ç¡®è®¤â€  </p>
<h3 id="deposit-æ·»åŠ æµåŠ¨æ€§"><a href="#deposit-æ·»åŠ æµåŠ¨æ€§" class="headerlink" title="deposit(æ·»åŠ æµåŠ¨æ€§)"></a>deposit(æ·»åŠ æµåŠ¨æ€§)</h3><blockquote>
<p>è®¡ç®—ç­‰ä»·æ‰€éœ€çš„ token0 å’Œ token1ï¼Œç”¨æˆ·è½¬å…¥è¿™äº› tokenï¼Œç³»ç»Ÿå‘å…¶è´¦æˆ·é“¸é€ å¯¹åº” LP tokenã€‚</p>
</blockquote>
<h4 id="å‚æ•°æ ¡éªŒ"><a href="#å‚æ•°æ ¡éªŒ" class="headerlink" title="å‚æ•°æ ¡éªŒ"></a>å‚æ•°æ ¡éªŒ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">require_gt!(lp_token_amount, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>è¦æ±‚ç”¨æˆ·æ³¨å…¥çš„ LP token æ•°é‡ &gt; 0ã€‚</li>
</ul>
<hr>
<h4 id="æ ¡éªŒæ˜¯å¦å…è®¸å­˜å…¥"><a href="#æ ¡éªŒæ˜¯å¦å…è®¸å­˜å…¥" class="headerlink" title="æ ¡éªŒæ˜¯å¦å…è®¸å­˜å…¥"></a>æ ¡éªŒæ˜¯å¦å…è®¸å­˜å…¥</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> !pool_state.<span class="title function_ invoke__">get_status_by_bit</span>(PoolStatusBitIndex::Deposit) &#123;</span><br><span class="line">    <span class="keyword">return</span> err!(ErrorCode::NotApproved);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>get_status_by_bit</code> æ˜¯çŠ¶æ€ä½æ§åˆ¶ï¼Œç¡®è®¤å½“å‰æ± å­æ˜¯å¦å¼€æ”¾ <code>Deposit</code> æ“ä½œã€‚</li>
</ul>
<hr>
<h4 id="è·å–å½“å‰-vault-ä¸­çš„-token-æ•°é‡ï¼ˆæ‰£æ‰æœªæ”¶æ‰‹ç»­è´¹ï¼‰"><a href="#è·å–å½“å‰-vault-ä¸­çš„-token-æ•°é‡ï¼ˆæ‰£æ‰æœªæ”¶æ‰‹ç»­è´¹ï¼‰" class="headerlink" title="è·å–å½“å‰ vault ä¸­çš„ token æ•°é‡ï¼ˆæ‰£æ‰æœªæ”¶æ‰‹ç»­è´¹ï¼‰"></a>è·å–å½“å‰ vault ä¸­çš„ token æ•°é‡ï¼ˆæ‰£æ‰æœªæ”¶æ‰‹ç»­è´¹ï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> (total_token_0_amount, total_token_1_amount) = pool_state.<span class="title function_ invoke__">vault_amount_without_fee</span>(</span><br><span class="line">    ctx.accounts.token_0_vault.amount,</span><br><span class="line">    ctx.accounts.token_1_vault.amount,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>vault ä¸­çš„ token æ•°é‡æ‰£é™¤æ‰åè®®è´¹éƒ¨åˆ†ï¼Œå¾—åˆ°<strong>å½“å‰å®é™…å¯ç”¨ token é‡</strong>ã€‚</li>
</ul>
<hr>
<h4 id="æ ¹æ®-LP-token-æ•°é‡-â†’-åæ¨ç”¨æˆ·è¦æä¾›çš„-token0-token1"><a href="#æ ¹æ®-LP-token-æ•°é‡-â†’-åæ¨ç”¨æˆ·è¦æä¾›çš„-token0-token1" class="headerlink" title="æ ¹æ® LP token æ•°é‡ â†’ åæ¨ç”¨æˆ·è¦æä¾›çš„ token0&#x2F;token1"></a>æ ¹æ® LP token æ•°é‡ â†’ åæ¨ç”¨æˆ·è¦æä¾›çš„ token0&#x2F;token1</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">results</span> = CurveCalculator::<span class="title function_ invoke__">lp_tokens_to_trading_tokens</span>(</span><br><span class="line">    <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(lp_token_amount),</span><br><span class="line">    <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(pool_state.lp_supply),</span><br><span class="line">    <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_token_0_amount),</span><br><span class="line">    <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_token_1_amount),</span><br><span class="line">    RoundDirection::Ceiling,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨å½“å‰æ± å­çŠ¶æ€åæ¨å‡ºï¼Œ<strong>å¦‚æœæ± ä¸­æ€»å…±æœ‰ <strong><code>**lp_supply**</code></strong>ï¼Œé‚£ä¹ˆç”¨æˆ·è¦æ³¨å…¥ <strong><code>**lp_token_amount**</code></strong>ï¼Œéœ€è¦å¯¹åº”æ³¨å…¥å¤šå°‘ token0 å’Œ token1ã€‚</strong></li>
</ul>
<p>ä¾‹å¦‚ï¼š<br>å‡è®¾æ€»æµåŠ¨æ€§ä¸º 1000ï¼Œç”¨æˆ·æƒ³æ³¨å…¥ 100 ä¸ª LP tokenï¼Œ<br>ä¸”æ± ä¸­å·²æœ‰ token0 &#x3D; 500, token1 &#x3D; 1000ï¼Œ<br>åˆ™åæ¨å‡ºç”¨æˆ·éœ€è¦æ³¨å…¥ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">token0 = (<span class="number">100</span> / <span class="number">1000</span>) * <span class="number">500</span> = <span class="number">50</span></span><br><span class="line">token1 = (<span class="number">100</span> / <span class="number">1000</span>) * <span class="number">1000</span> = <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h5 id="å…·ä½“å®ç°é€»è¾‘"><a href="#å…·ä½“å®ç°é€»è¾‘" class="headerlink" title="å…·ä½“å®ç°é€»è¾‘"></a>å…·ä½“å®ç°é€»è¾‘</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_tokens_to_trading_tokens</span>(</span><br><span class="line">        lp_token_amount: <span class="type">u128</span>, <span class="comment">// æˆ‘æƒ³å…‘æ¢çš„ LP token æ•°é‡</span></span><br><span class="line">        lp_token_supply: <span class="type">u128</span>,  <span class="comment">// å½“å‰æ± å­çš„æ€» LP token ä¾›åº”é‡</span></span><br><span class="line">        swap_token_0_amount: <span class="type">u128</span>, <span class="comment">// æ± ä¸­ token_0 çš„å®é™…ä½™é¢ï¼ˆä¸å«æ‰‹ç»­è´¹ï¼‰</span></span><br><span class="line">        swap_token_1_amount: <span class="type">u128</span>,  <span class="comment">// æ± ä¸­ token_1 çš„å®é™…ä½™é¢ï¼ˆä¸å«æ‰‹ç»­è´¹ï¼‰</span></span><br><span class="line">        round_direction: RoundDirection, <span class="comment">// å–æ•´æ–¹å‘ï¼ˆFloor å‘ä¸‹å–æ•´ï¼ŒCeiling å‘ä¸Šå–æ•´ï¼‰</span></span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;TradingTokenResult&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">token_0_amount</span> = lp_token_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(swap_token_0_amount)?</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(lp_token_supply)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">token_1_amount</span> = lp_token_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(swap_token_1_amount)?</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(lp_token_supply)?;</span><br><span class="line">        <span class="keyword">let</span> (token_0_amount, token_1_amount) = <span class="keyword">match</span> round_direction &#123;</span><br><span class="line">            RoundDirection::Floor =&gt; (token_0_amount, token_1_amount),</span><br><span class="line">            RoundDirection::Ceiling =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">token_0_remainder</span> = lp_token_amount</span><br><span class="line">                    .<span class="title function_ invoke__">checked_mul</span>(swap_token_0_amount)?</span><br><span class="line">                    .<span class="title function_ invoke__">checked_rem</span>(lp_token_supply)?;</span><br><span class="line">                <span class="comment">// Also check for 0 token A and B amount to avoid taking too much</span></span><br><span class="line">                <span class="comment">// for tiny amounts of pool tokens.  For example, if someone asks</span></span><br><span class="line">                <span class="comment">// for 1 pool token, which is worth 0.01 token A, we avoid the</span></span><br><span class="line">                <span class="comment">// ceiling of taking 1 token A and instead return 0, for it to be</span></span><br><span class="line">                <span class="comment">// rejected later in processing.</span></span><br><span class="line">                <span class="keyword">if</span> token_0_remainder &gt; <span class="number">0</span> &amp;&amp; token_0_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    token_0_amount += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">token_1_remainder</span> = lp_token_amount</span><br><span class="line">                    .<span class="title function_ invoke__">checked_mul</span>(swap_token_1_amount)?</span><br><span class="line">                    .<span class="title function_ invoke__">checked_rem</span>(lp_token_supply)?;</span><br><span class="line">                <span class="keyword">if</span> token_1_remainder &gt; <span class="number">0</span> &amp;&amp; token_1_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    token_1_amount += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                (token_0_amount, token_1_amount)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(TradingTokenResult &#123;</span><br><span class="line">            token_0_amount,</span><br><span class="line">            token_1_amount,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ ¸å¿ƒè®¡ç®—é€»è¾‘"><a href="#æ ¸å¿ƒè®¡ç®—é€»è¾‘" class="headerlink" title="æ ¸å¿ƒè®¡ç®—é€»è¾‘"></a>æ ¸å¿ƒè®¡ç®—é€»è¾‘</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">token_0_amount = (lp_token_amount * swap_token_0_amount) / lp_token_supply</span><br><span class="line">token_1_amount = (lp_token_amount * swap_token_1_amount) / lp_token_supply</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™æ˜¯æŒ‰ <strong>LP Token å æ€»ä¾›åº”çš„æ¯”ä¾‹</strong>ï¼Œæ¥è®¡ç®—ä½ åº”è¯¥æ‹¿åˆ°å¤šå°‘ token_0 &#x2F; token_1ã€‚</li>
<li>ä¾‹å¦‚ï¼š</li>
<li>æ± å­ä¸­æœ‰ 10000 LPï¼Œæ€»å…± 5000 token_0ï¼Œé‚£ä¹ˆä½ æŒæœ‰ 100 LP tokenï¼›</li>
<li>é‚£ä½ å°±èƒ½æ‹¿å› <code>(100 / 10000) * 5000 = 50</code> ä¸ª token_0ã€‚</li>
</ul>
<h6 id="RoundDirection-Ceiling-ç‰¹æ®Šé€»è¾‘"><a href="#RoundDirection-Ceiling-ç‰¹æ®Šé€»è¾‘" class="headerlink" title="RoundDirection::Ceiling ç‰¹æ®Šé€»è¾‘"></a>RoundDirection::Ceiling ç‰¹æ®Šé€»è¾‘</h6><p> å¦‚æœé€‰æ‹© <strong>å‘ä¸Šå–æ•´</strong>ï¼š  </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> token_0_remainder &gt; <span class="number">0</span> &amp;&amp; token_0_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">    token_0_amount += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç²¾åº¦æŸå¤±å¯¼è‡´ç”¨æˆ·äºæŸï¼Œä¾‹å¦‚ä½ è¯¥å¾— 0.001 ä¸ª tokenï¼Œç»“æœå–æ•´æˆ 0ï¼Œé‚£å¾ˆäºã€‚äºæ˜¯æœ‰ä½™æ•°æ—¶åŠ  1ï¼Œç»™å¤šä¸€ç‚¹ï¼Œç”¨æˆ·ä¸äºã€‚</p>
<p>ä½†ä¹ŸåŠ äº†åˆ¤æ–­é¿å…å°é¢æ”»å‡»ï¼ˆä¾‹å¦‚ 1 ä¸ª LP å æ¯”å¤ªä½ï¼Œç»“æœç¡¬å–å‡º 1 tokenï¼‰ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> token_0_amount == <span class="number">0</span>ï¼Œå°±ä¸ä¼šåŠ  <span class="number">1</span>ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="è€ƒè™‘-Transfer-Fee-çš„åå‘æ¢ç®—"><a href="#è€ƒè™‘-Transfer-Fee-çš„åå‘æ¢ç®—" class="headerlink" title="è€ƒè™‘ Transfer Fee çš„åå‘æ¢ç®—"></a>è€ƒè™‘ Transfer Fee çš„åå‘æ¢ç®—</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> (transfer_token_0_amount, transfer_token_0_fee) = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_fee</span> = <span class="title function_ invoke__">get_transfer_inverse_fee</span>(...);</span><br><span class="line">    (token_0_amount + fee, fee)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸€äº› SPL Tokenï¼ˆå¦‚ USDTï¼‰å¼€å¯äº† Transfer Feeï¼ˆè½¬è´¦ä¼šæ‰£é’±ï¼‰ï¼Œ</li>
<li>æ‰€ä»¥è¦æ ¹æ®ç”¨æˆ·æœ€ç»ˆè¦è½¬å…¥çš„ <code>token_0_amount</code>ï¼Œ<strong>åæ¨å‡ºç”¨æˆ·éœ€è¦å®é™…è½¬è´¦ <strong><code>**amount + fee**</code></strong> æ‰èƒ½æœ€ç»ˆåˆ°è¾¾ç›®æ ‡æ•°é‡ã€‚</strong></li>
</ul>
<hr>
<h4 id="æ»‘ç‚¹åˆ¤æ–­"><a href="#æ»‘ç‚¹åˆ¤æ–­" class="headerlink" title="æ»‘ç‚¹åˆ¤æ–­"></a>æ»‘ç‚¹åˆ¤æ–­</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> transfer_token_0_amount &gt; maximum_token_0_amount</span><br><span class="line">    || transfer_token_1_amount &gt; maximum_token_1_amount &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::ExceededSlippage.<span class="title function_ invoke__">into</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> æˆ‘è¦å­˜å…¥ 1000 LPï¼Œæœ€å¤šåªèƒ½èŠ± 200 ä¸ª token0 å’Œ 300 ä¸ª token1ã€‚è¶…è¿‡å°±ä¸æ¥å—ï¼Œå› ä¸ºè¿™è¶…å‡ºäº†æˆ‘æ„¿æ„æ‰¿å—çš„æ»‘ç‚¹ã€‚  </p>
</blockquote>
<ul>
<li>å¦‚æœç”¨æˆ·ä¼ å…¥çš„æœ€å¤§æ¥æ”¶é‡ <code>maximum_token_x_amount</code> å¤ªå°ï¼Œè¯´æ˜å‘ç”Ÿæ»‘ç‚¹ï¼Œäº¤æ˜“ä¸­æ–­ã€‚</li>
</ul>
<hr>
<h4 id="å¼€å§‹å®é™…è½¬è´¦-token0-å’Œ-token1"><a href="#å¼€å§‹å®é™…è½¬è´¦-token0-å’Œ-token1" class="headerlink" title="å¼€å§‹å®é™…è½¬è´¦ token0 å’Œ token1"></a>å¼€å§‹å®é™…è½¬è´¦ token0 å’Œ token1</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(...)</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™ä¸¤ä¸ªå‡½æ•°å°† token ä»ç”¨æˆ·è´¦æˆ·è½¬å…¥æ± å­çš„ token vaultã€‚</li>
</ul>
<hr>
<h4 id="ä¿®æ”¹æ± å­çš„-LP-æ€»é‡-ç»™ç”¨æˆ·é“¸é€ -LP-token"><a href="#ä¿®æ”¹æ± å­çš„-LP-æ€»é‡-ç»™ç”¨æˆ·é“¸é€ -LP-token" class="headerlink" title="ä¿®æ”¹æ± å­çš„ LP æ€»é‡ &amp; ç»™ç”¨æˆ·é“¸é€  LP token"></a>ä¿®æ”¹æ± å­çš„ LP æ€»é‡ &amp; ç»™ç”¨æˆ·é“¸é€  LP token</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pool_state.lp_supply += lp_token_amount;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">token_mint_to</span>(..., lp_token_amount)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="è®°å½•æœ€æ–°-epochï¼Œå®Œæˆ"><a href="#è®°å½•æœ€æ–°-epochï¼Œå®Œæˆ" class="headerlink" title="è®°å½•æœ€æ–° epochï¼Œå®Œæˆ"></a>è®°å½•æœ€æ–° epochï¼Œå®Œæˆ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pool_state.recent_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="å¯èƒ½å…³å¿ƒçš„å‡ ä¸ªç‚¹"><a href="#å¯èƒ½å…³å¿ƒçš„å‡ ä¸ªç‚¹" class="headerlink" title="å¯èƒ½å…³å¿ƒçš„å‡ ä¸ªç‚¹"></a>å¯èƒ½å…³å¿ƒçš„å‡ ä¸ªç‚¹</h4><h5 id="lp-tokens-to-trading-tokens-æ˜¯æ€ä¹ˆè®¡ç®—-token-æ•°é‡çš„ï¼Ÿ"><a href="#lp-tokens-to-trading-tokens-æ˜¯æ€ä¹ˆè®¡ç®—-token-æ•°é‡çš„ï¼Ÿ" class="headerlink" title="lp_tokens_to_trading_tokens æ˜¯æ€ä¹ˆè®¡ç®— token æ•°é‡çš„ï¼Ÿ"></a><code>lp_tokens_to_trading_tokens</code> æ˜¯æ€ä¹ˆè®¡ç®— token æ•°é‡çš„ï¼Ÿ</h5><p>è¿™æ˜¯æ ¹æ®ä»¥ä¸‹å…¬å¼æ¨å¯¼çš„ï¼ˆç®€åŒ–ä¸ºæ¯”ä¾‹å…³ç³»ï¼‰ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">token_x_amount = (lp_token_amount / lp_supply) * vault_token_x</span><br></pre></td></tr></table></figure>

<p>å³ç”¨æˆ·æ‰“ç®—æ³¨å…¥å¤šå°‘ LP tokenï¼Œå°±å¾—æä¾›å¤šå°‘æ¯”ä¾‹çš„ token0 å’Œ token1ã€‚</p>
<hr>
<h5 id="transfer-fee-ç›¸å…³ä¸ºä»€ä¹ˆéœ€è¦åŠ ï¼Ÿ"><a href="#transfer-fee-ç›¸å…³ä¸ºä»€ä¹ˆéœ€è¦åŠ ï¼Ÿ" class="headerlink" title="transfer_fee ç›¸å…³ä¸ºä»€ä¹ˆéœ€è¦åŠ ï¼Ÿ"></a>transfer_fee ç›¸å…³ä¸ºä»€ä¹ˆéœ€è¦åŠ ï¼Ÿ</h5><p>æŸäº› Token å¯ç”¨äº† â€œtransfer feeâ€ ï¼ˆå¦‚ USDTã€USDC-2022ï¼‰ï¼Œä½ è½¬è´¦ 100 å®é™…åªåˆ°è´¦ 98ï¼Œæ‰€ä»¥éœ€è¦åå‘è®¡ç®—å‡ºï¼š</p>
<p>ä½ è¦åˆ°è´¦ 100ï¼Œéœ€è¦å‘å‡º 102ï¼ˆæ‰‹ç»­è´¹ + å®å¾— &#x3D; 100ï¼‰</p>
<p>è¿™å°±æ˜¯ <code>get_transfer_inverse_fee</code> çš„ç”¨é€”ã€‚</p>
<hr>
<h5 id="ä¸ºä»€ä¹ˆæœ‰æœ€å¤§-token0-å’Œ-token1-å‚æ•°ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæœ‰æœ€å¤§-token0-å’Œ-token1-å‚æ•°ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰æœ€å¤§ token0 å’Œ token1 å‚æ•°ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæœ‰æœ€å¤§ token0 å’Œ token1 å‚æ•°ï¼Ÿ</h5><p>ä¸ºäº†æ§åˆ¶æ»‘ç‚¹ã€‚ç”¨æˆ·æ„¿æ„æ³¨å…¥çš„æœ€å¤š token0&#x2F;token1 æ˜¯æœ‰é™çš„ï¼Œè¶…è¿‡å°±è®¤ä¸ºæ»‘ç‚¹å¤ªå¤§æ‹’ç»æ“ä½œã€‚</p>
<hr>
<h4 id="æ€»ç»“æµç¨‹å›¾"><a href="#æ€»ç»“æµç¨‹å›¾" class="headerlink" title="æ€»ç»“æµç¨‹å›¾"></a>æ€»ç»“æµç¨‹å›¾</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">       ç”¨æˆ·ä¼ å…¥ï¼š</span><br><span class="line"> lp_token_amount, max_token0, max_token1</span><br><span class="line">              â†“</span><br><span class="line">è®¡ç®— vault å½“å‰çŠ¶æ€ï¼ˆé™¤åè®®è´¹ï¼‰</span><br><span class="line">              â†“</span><br><span class="line"> lp_tokens_to_trading_tokens åæ¨æ³¨å…¥éœ€è¦çš„ token0 / token1</span><br><span class="line">              â†“</span><br><span class="line"> åŠ ä¸Š Transfer Fee â†’ å®é™…è¦è½¬è´¦ token æ•°é‡</span><br><span class="line">              â†“</span><br><span class="line">     æ ¡éªŒæ˜¯å¦è¶…å‡ºæœ€å¤§ï¼ˆæ»‘ç‚¹ï¼‰</span><br><span class="line">              â†“</span><br><span class="line">     ç”¨æˆ·è½¬è´¦ token0 / token1 åˆ°æ± </span><br><span class="line">              â†“</span><br><span class="line">    æ›´æ–°æ± å­çš„ lp_supply</span><br><span class="line">              â†“</span><br><span class="line">  ç»™ç”¨æˆ·é“¸é€  LP tokenï¼Œæ›´æ–° epoch</span><br></pre></td></tr></table></figure>

<h3 id="withdraw-æç°å‡å°‘æµåŠ¨æ€§"><a href="#withdraw-æç°å‡å°‘æµåŠ¨æ€§" class="headerlink" title="withdraw(æç°å‡å°‘æµåŠ¨æ€§)"></a>withdraw(æç°å‡å°‘æµåŠ¨æ€§)</h3><blockquote>
<p>å’Œæ·»åŠ æµåŠ¨æ€§å·®ä¸å¤š</p>
</blockquote>
<h3 id="swap-base-input-åŸºäºè¾“å…¥çš„æ•°é‡è¿›è¡Œäº¤æ¢"><a href="#swap-base-input-åŸºäºè¾“å…¥çš„æ•°é‡è¿›è¡Œäº¤æ¢" class="headerlink" title="swap_base_input(åŸºäºè¾“å…¥çš„æ•°é‡è¿›è¡Œäº¤æ¢)"></a>swap_base_input(åŸºäºè¾“å…¥çš„æ•°é‡è¿›è¡Œäº¤æ¢)</h3><blockquote>
<p> ç”¨æˆ·æŒ‡å®šè¾“å…¥ tokenï¼ˆ<code>amount_in</code>ï¼‰ï¼Œæ ¹æ®æ± å­å‚¨å¤‡é‡ã€äº¤æ˜“è´¹ç‡ç­‰è®¡ç®—å‡ºèƒ½æ¢åˆ°çš„è¾“å‡º tokenï¼ˆ<code>amount_out</code>ï¼‰ï¼Œå¦‚æœæ¢åˆ°çš„ token å¤§äºç­‰äº <code>minimum_amount_out</code>ï¼Œåˆ™è¿›è¡Œ swap äº¤æ˜“å¹¶è½¬è´¦ã€‚  </p>
</blockquote>
<h4 id="1-æ ¡éªŒæ˜¯å¦å…è®¸äº¤æ¢"><a href="#1-æ ¡éªŒæ˜¯å¦å…è®¸äº¤æ¢" class="headerlink" title="1. æ ¡éªŒæ˜¯å¦å…è®¸äº¤æ¢"></a>1. æ ¡éªŒæ˜¯å¦å…è®¸äº¤æ¢</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> !pool_state.<span class="title function_ invoke__">get_status_by_bit</span>(PoolStatusBitIndex::Swap)</span><br><span class="line">    || block_timestamp &lt; pool_state.open_time</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ¤æ–­æ± æ˜¯å¦å¼€å¯äº† <code>Swap</code> æƒé™</li>
<li>å½“å‰åŒºå—æ—¶é—´æ˜¯å¦æ™šäºæ± çš„å¼€æ”¾æ—¶é—´</li>
</ul>
<hr>
<h4 id="2-æ‰£é™¤è¾“å…¥è½¬è´¦æ‰‹ç»­è´¹"><a href="#2-æ‰£é™¤è¾“å…¥è½¬è´¦æ‰‹ç»­è´¹" class="headerlink" title="2. æ‰£é™¤è¾“å…¥è½¬è´¦æ‰‹ç»­è´¹"></a>2. æ‰£é™¤è¾“å…¥è½¬è´¦æ‰‹ç»­è´¹</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">transfer_fee</span> = <span class="title function_ invoke__">get_transfer_fee</span>(&amp;ctx.accounts.input_token_mint.<span class="title function_ invoke__">to_account_info</span>(), amount_in)?;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">actual_amount_in</span> = amount_in.<span class="title function_ invoke__">saturating_sub</span>(transfer_fee);</span><br></pre></td></tr></table></figure>

<ul>
<li>ä»ç”¨æˆ·è½¬è¿›çš„ token å¯èƒ½æ˜¯ token-2022ï¼Œå¸¦è½¬è´¦æ‰‹ç»­è´¹</li>
<li>å®é™…è¿›æ± çš„æ•°é‡æ˜¯ <code>amount_in - æ‰‹ç»­è´¹</code></li>
</ul>
<hr>
<h4 id="3-åˆ¤æ–­è¾“å…¥-è¾“å‡º-vault-æ˜¯-token0-è¿˜æ˜¯-token1"><a href="#3-åˆ¤æ–­è¾“å…¥-è¾“å‡º-vault-æ˜¯-token0-è¿˜æ˜¯-token1" class="headerlink" title="3. åˆ¤æ–­è¾“å…¥&#x2F;è¾“å‡º vault æ˜¯ token0 è¿˜æ˜¯ token1"></a>3. åˆ¤æ–­è¾“å…¥&#x2F;è¾“å‡º vault æ˜¯ token0 è¿˜æ˜¯ token1</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> ctx.accounts.input_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_0_vault ...</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ¤æ–­æ˜¯ token0 -&gt; token1ï¼Œè¿˜æ˜¯ token1 -&gt; token0 çš„äº¤æ˜“æ–¹å‘</li>
<li>è·å–æ± ä¸­å½“å‰ vault ä¸­ token çš„æ•°é‡ï¼Œè®°ä¸º <code>total_input_token_amount</code> å’Œ <code>total_output_token_amount</code></li>
</ul>
<hr>
<h4 id="4-è°ƒç”¨æ ¸å¿ƒæ›²çº¿å‡½æ•°"><a href="#4-è°ƒç”¨æ ¸å¿ƒæ›²çº¿å‡½æ•°" class="headerlink" title="4. è°ƒç”¨æ ¸å¿ƒæ›²çº¿å‡½æ•°"></a>4. è°ƒç”¨æ ¸å¿ƒæ›²çº¿å‡½æ•°</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = CurveCalculator::<span class="title function_ invoke__">swap_base_input</span>(...)</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¼ å…¥ï¼š<ul>
<li>ç”¨æˆ·å®é™…è½¬å…¥æ•°é‡ï¼ˆå·²å‡æ‰‹ç»­è´¹ï¼‰</li>
<li>æ± ä¸­ token0 å’Œ token1 æ•°é‡</li>
<li>æ‰‹ç»­è´¹ç‡</li>
</ul>
</li>
<li>è¿”å›è®¡ç®—ç»“æœç»“æ„ä½“ï¼ŒåŒ…å«ï¼š<ul>
<li>å®é™…è¢«äº¤æ¢çš„ token æ•°é‡</li>
<li>äº¤æ¢åæ± ä¸­ token æ•°é‡</li>
<li>æ”¶å–çš„æ‰‹ç»­è´¹ï¼ˆprotocol + fundï¼‰</li>
</ul>
</li>
</ul>
<h5 id="è¯¦è§£"><a href="#è¯¦è§£" class="headerlink" title="è¯¦è§£"></a>è¯¦è§£</h5><p>è®¡ç®—ä¸€ä¸ªåŸºäº <strong>è¾“å…¥æ•°é‡å›ºå®š</strong>ï¼ˆbase inputï¼‰çš„ swap æ“ä½œï¼Œè€ƒè™‘ï¼š</p>
<ul>
<li>äº¤æ˜“è´¹ (<code>trade_fee</code>)</li>
<li>åè®®è´¹ (<code>protocol_fee</code>)</li>
<li>åŸºé‡‘è´¹ (<code>fund_fee</code>)</li>
<li>swap åçš„æ± å­æ–°çŠ¶æ€ï¼ˆtoken reserve æ”¹å˜ï¼‰</li>
<li>ç”¨æˆ·èƒ½æ‹¿åˆ°å¤šå°‘è¾“å‡º token</li>
</ul>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å«ä¹‰</th>
<th>æ•°å€¼ï¼ˆä¸¾ä¾‹ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>source_amount</code></td>
<td>ç”¨æˆ·è¾“å…¥ token æ•°é‡</td>
<td><code>1_000_000</code>ï¼ˆå³ 1e6 å•ä½ï¼‰</td>
</tr>
<tr>
<td><code>swap_source_amount</code></td>
<td>æ± ä¸­åŸæœ¬çš„è¾“å…¥ tokenï¼ˆtoken Aï¼‰æ•°é‡</td>
<td><code>10_000_000</code></td>
</tr>
<tr>
<td><code>swap_destination_amount</code></td>
<td>æ± ä¸­åŸæœ¬çš„è¾“å‡º tokenï¼ˆtoken Bï¼‰æ•°é‡</td>
<td><code>5_000_000</code></td>
</tr>
<tr>
<td><code>trade_fee_rate</code></td>
<td>äº¤æ˜“æ€»æ‰‹ç»­è´¹ç‡ï¼ˆä¸‡åˆ†åˆ¶ï¼‰</td>
<td><code>30</code>ï¼ˆå³ 0.3%ï¼‰</td>
</tr>
<tr>
<td><code>protocol_fee_rate</code></td>
<td>åè®®åœ¨æ€»æ‰‹ç»­è´¹ä¸­æŠ½æˆæ¯”ä¾‹</td>
<td><code>1666</code>ï¼ˆå³ 16.66%ï¼Œå³ 1&#x2F;6ï¼‰</td>
</tr>
<tr>
<td><code>fund_fee_rate</code></td>
<td>åŸºé‡‘æŠ½æˆæ¯”ä¾‹</td>
<td><code>3333</code>ï¼ˆå³ 33.33%ï¼Œå³ 1&#x2F;3ï¼‰</td>
</tr>
</tbody></table>
<h5 id="æ­¥éª¤è®¡ç®—ï¼š"><a href="#æ­¥éª¤è®¡ç®—ï¼š" class="headerlink" title="æ­¥éª¤è®¡ç®—ï¼š"></a>æ­¥éª¤è®¡ç®—ï¼š</h5><h6 id="è®¡ç®—æ€»äº¤æ˜“æ‰‹ç»­è´¹-trade-fee"><a href="#è®¡ç®—æ€»äº¤æ˜“æ‰‹ç»­è´¹-trade-fee" class="headerlink" title="è®¡ç®—æ€»äº¤æ˜“æ‰‹ç»­è´¹ trade_fee"></a>è®¡ç®—æ€»äº¤æ˜“æ‰‹ç»­è´¹ <code>trade_fee</code></h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">trade_fee</span> = Fees::<span class="title function_ invoke__">trading_fee</span>(source_amount, trade_fee_rate)?;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">trade_fee = <span class="number">1_000_000</span> * <span class="number">30</span> / <span class="number">10_000</span> = <span class="number">3_000</span></span><br></pre></td></tr></table></figure>

<hr>
<h6 id="åˆ†æ‘Šåè®®è´¹å’ŒåŸºé‡‘è´¹"><a href="#åˆ†æ‘Šåè®®è´¹å’ŒåŸºé‡‘è´¹" class="headerlink" title="åˆ†æ‘Šåè®®è´¹å’ŒåŸºé‡‘è´¹"></a>åˆ†æ‘Šåè®®è´¹å’ŒåŸºé‡‘è´¹</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">protocol_fee = trade_fee * protocol_fee_rate / <span class="number">10_000</span></span><br><span class="line">= <span class="number">3_000</span> * <span class="number">1666</span> / <span class="number">10_000</span> â‰ˆ <span class="number">499</span></span><br><span class="line"></span><br><span class="line">fund_fee = trade_fee * fund_fee_rate / <span class="number">10_000</span></span><br><span class="line">= <span class="number">3_000</span> * <span class="number">3333</span> / <span class="number">10_000</span> â‰ˆ <span class="number">999</span></span><br></pre></td></tr></table></figure>

<hr>
<h6 id="å®é™…ç”¨äºäº¤æ˜“çš„å‡€è¾“å…¥æ•°é‡"><a href="#å®é™…ç”¨äºäº¤æ˜“çš„å‡€è¾“å…¥æ•°é‡" class="headerlink" title="å®é™…ç”¨äºäº¤æ˜“çš„å‡€è¾“å…¥æ•°é‡"></a>å®é™…ç”¨äºäº¤æ˜“çš„å‡€è¾“å…¥æ•°é‡</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">source_amount_less_fees = <span class="number">1_000_000</span> - <span class="number">3_000</span> = <span class="number">997_000</span></span><br></pre></td></tr></table></figure>

<hr>
<h6 id="è®¡ç®—ç”¨æˆ·å¯è·å¾—çš„ç›®æ ‡-tokenï¼ˆç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼‰ï¼š"><a href="#è®¡ç®—ç”¨æˆ·å¯è·å¾—çš„ç›®æ ‡-tokenï¼ˆç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼‰ï¼š" class="headerlink" title="è®¡ç®—ç”¨æˆ·å¯è·å¾—çš„ç›®æ ‡ tokenï¼ˆç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼‰ï¼š"></a>è®¡ç®—ç”¨æˆ·å¯è·å¾—çš„ç›®æ ‡ tokenï¼ˆç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼‰ï¼š</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">destination_amount_swapped = ConstantProductCurve::<span class="title function_ invoke__">swap_base_input_without_fees</span>(</span><br><span class="line">    <span class="number">997_000</span>,  <span class="comment">// ç”¨æˆ·å‡€è¾“å…¥æ•°é‡</span></span><br><span class="line">    <span class="number">10_000_000</span>, <span class="comment">// x: åŸæ± å­ token A æ•°é‡</span></span><br><span class="line">    <span class="number">5_000_000</span>,  <span class="comment">// y: åŸæ± å­ token B æ•°é‡</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h6 id="æ’å®šä¹˜ç§¯æ›²çº¿å…¬å¼ï¼ˆx-y-kï¼‰"><a href="#æ’å®šä¹˜ç§¯æ›²çº¿å…¬å¼ï¼ˆx-y-kï¼‰" class="headerlink" title="æ’å®šä¹˜ç§¯æ›²çº¿å…¬å¼ï¼ˆx * y &#x3D; kï¼‰:"></a>æ’å®šä¹˜ç§¯æ›²çº¿å…¬å¼ï¼ˆx * y &#x3D; kï¼‰:</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Î”y = y - (k / (x + Î”x)) </span><br><span class="line">= <span class="number">5_000_000</span> - (<span class="number">10_000_000</span> * <span class="number">5_000_000</span>) / (<span class="number">10_000_000</span> + <span class="number">997_000</span>)</span><br><span class="line">= <span class="number">5_000_000</span> - (<span class="number">50_000_000_000_000</span> / <span class="number">10_997_000</span>)</span><br><span class="line">â‰ˆ <span class="number">5_000_000</span> - <span class="number">4_546_176</span> â‰ˆ <span class="number">453_824</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œç”¨æˆ·å°†è·å¾— <code>â‰ˆ 453_824</code> å•ä½çš„ token B</p>
<hr>
<h6 id="ç”Ÿæˆç»“æœç»“æ„ä½“ï¼š"><a href="#ç”Ÿæˆç»“æœç»“æ„ä½“ï¼š" class="headerlink" title="ç”Ÿæˆç»“æœç»“æ„ä½“ï¼š"></a>ç”Ÿæˆç»“æœç»“æ„ä½“ï¼š</h6><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Some</span>(SwapResult &#123;</span><br><span class="line">    new_swap_source_amount: <span class="number">10_000_000</span> + <span class="number">1_000_000</span> = <span class="number">11_000_000</span>,</span><br><span class="line">    new_swap_destination_amount: <span class="number">5_000_000</span> - <span class="number">453_824</span> = <span class="number">4_546_176</span>,</span><br><span class="line">    source_amount_swapped: <span class="number">1_000_000</span>,</span><br><span class="line">    destination_amount_swapped: <span class="number">453_824</span>,</span><br><span class="line">    trade_fee: <span class="number">3_000</span>,</span><br><span class="line">    protocol_fee: <span class="number">499</span>,</span><br><span class="line">    fund_fee: <span class="number">999</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>è®¡ç®—å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>ç”¨æˆ·è¾“å…¥ï¼ˆåŸå§‹ï¼‰</td>
<td><code>1_000_000</code></td>
</tr>
<tr>
<td>äº¤æ˜“æ€»æ‰‹ç»­è´¹</td>
<td><code>3_000</code></td>
</tr>
<tr>
<td>åè®®æ‰‹ç»­è´¹</td>
<td><code>499</code></td>
</tr>
<tr>
<td>åŸºé‡‘æ‰‹ç»­è´¹</td>
<td><code>999</code></td>
</tr>
<tr>
<td>å®é™… swap çš„æ•°é‡</td>
<td><code>997_000</code></td>
</tr>
<tr>
<td>ç”¨æˆ·èƒ½æ‹¿åˆ°çš„è¾“å‡º token æ•°é‡</td>
<td><code>â‰ˆ 453_824</code></td>
</tr>
<tr>
<td>æ± ä¸­æ–°çš„ token A æ•°é‡</td>
<td><code>11_000_000</code></td>
</tr>
<tr>
<td>æ± ä¸­æ–°çš„ token B æ•°é‡</td>
<td><code>4_546_176</code></td>
</tr>
</tbody></table>
<hr>
<h4 id="5-æ ¡éªŒäº¤æ¢å‰åå¸¸æ•°ä¹˜ç§¯å…³ç³»"><a href="#5-æ ¡éªŒäº¤æ¢å‰åå¸¸æ•°ä¹˜ç§¯å…³ç³»" class="headerlink" title="5. æ ¡éªŒäº¤æ¢å‰åå¸¸æ•°ä¹˜ç§¯å…³ç³»"></a>5. æ ¡éªŒäº¤æ¢å‰åå¸¸æ•°ä¹˜ç§¯å…³ç³»</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">constant_before</span> = total_input_token_amount * total_output_token_amount;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">constant_after</span> = (new_amount_in - fee) * new_amount_out;</span><br><span class="line">require_gte!(constant_after, constant_before);</span><br></pre></td></tr></table></figure>

<ul>
<li>ç”¨äºéªŒè¯äº¤æ˜“æ˜¯å¦éµå®ˆ x*y&#x3D;k æ’å®šè§„åˆ™ï¼ˆæˆ–æœ‰æ‰€å¢é•¿ï¼‰</li>
</ul>
<hr>
<h4 id="6-æ£€æŸ¥è¾“å‡º-token-å‡å»æ‰‹ç»­è´¹æ˜¯å¦-â‰¥-ç”¨æˆ·è®¾ç½®çš„æœ€å°æ¥å—å€¼"><a href="#6-æ£€æŸ¥è¾“å‡º-token-å‡å»æ‰‹ç»­è´¹æ˜¯å¦-â‰¥-ç”¨æˆ·è®¾ç½®çš„æœ€å°æ¥å—å€¼" class="headerlink" title="6. æ£€æŸ¥è¾“å‡º token å‡å»æ‰‹ç»­è´¹æ˜¯å¦ â‰¥ ç”¨æˆ·è®¾ç½®çš„æœ€å°æ¥å—å€¼"></a>6. æ£€æŸ¥è¾“å‡º token å‡å»æ‰‹ç»­è´¹æ˜¯å¦ â‰¥ ç”¨æˆ·è®¾ç½®çš„æœ€å°æ¥å—å€¼</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">require_gte!(</span><br><span class="line">    amount_received,</span><br><span class="line">    minimum_amount_out,</span><br><span class="line">    ErrorCode::ExceededSlippage</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>é¿å…ç”¨æˆ·å› æ± ä»·æ ¼æ³¢åŠ¨æˆ–æ»‘ç‚¹å¤ªå¤§è€ŒäºæŸ</li>
</ul>
<hr>
<h4 id="7-ç´¯åŠ -protocol-å’Œ-fund-æ‰‹ç»­è´¹åˆ°æ± çš„-fee-å­—æ®µ"><a href="#7-ç´¯åŠ -protocol-å’Œ-fund-æ‰‹ç»­è´¹åˆ°æ± çš„-fee-å­—æ®µ" class="headerlink" title="7. ç´¯åŠ  protocol å’Œ fund æ‰‹ç»­è´¹åˆ°æ± çš„ fee å­—æ®µ"></a>7. ç´¯åŠ  protocol å’Œ fund æ‰‹ç»­è´¹åˆ°æ± çš„ fee å­—æ®µ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pool_state.protocol_fees_token_X += protocol_fee;</span><br><span class="line">pool_state.fund_fees_token_X += fund_fee;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="8-æ‰§è¡Œè½¬è´¦ï¼š"><a href="#8-æ‰§è¡Œè½¬è´¦ï¼š" class="headerlink" title="8. æ‰§è¡Œè½¬è´¦ï¼š"></a>8. æ‰§è¡Œè½¬è´¦ï¼š</h4><ul>
<li>ä»ç”¨æˆ·è´¦æˆ·è½¬å…¥ <code>input_vault</code></li>
<li>ä» <code>output_vault</code> è½¬ç»™ç”¨æˆ·</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(...)</span><br><span class="line"><span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(...)</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="9-è®°å½•-token-ä»·æ ¼è§‚å¯Ÿæ•°æ®"><a href="#9-è®°å½•-token-ä»·æ ¼è§‚å¯Ÿæ•°æ®" class="headerlink" title="9. è®°å½• token ä»·æ ¼è§‚å¯Ÿæ•°æ®"></a>9. è®°å½• token ä»·æ ¼è§‚å¯Ÿæ•°æ®</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ctx.accounts.observation_state.<span class="title function_ invoke__">load_mut</span>()?.<span class="title function_ invoke__">update</span>(...)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="emit-Event"><a href="#emit-Event" class="headerlink" title="emit Event"></a>emit Event</h2><p>å‘ Solana çš„æ—¥å¿—ç³»ç»Ÿå‘é€ <code>SwapEvent</code>ï¼Œç”¨äºå‰ç«¯ç›‘å¬æˆ–é“¾ä¸Šåˆ†æã€‚</p>
<hr>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>è¿™ä¸ªå‡½æ•°çš„æµç¨‹å›¾å¯å¤§è‡´ç®€åŒ–ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ç”¨æˆ·è¾“å…¥ amount_inï¼ˆå¸¦æ‰‹ç»­è´¹ï¼‰â¡ï¸</span><br><span class="line">        â¬‡ï¸</span><br><span class="line">è®¡ç®—å®é™…å…¥æ± æ•° â¡ï¸ ç”¨æ›²çº¿ç®—æ³•è®¡ç®—è¾“å‡º â¡ï¸</span><br><span class="line">        â¬‡ï¸                                    â¬‡ï¸</span><br><span class="line">æ›´æ–°æ± å­çŠ¶æ€                     è¾“å‡ºè½¬è´¦åˆ°ç”¨æˆ·è´¦æˆ·</span><br><span class="line">        â¬‡ï¸</span><br><span class="line">æ›´æ–°ä»·æ ¼è®°å½• â• å‘å‡ºäº‹ä»¶æ—¥å¿—</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://just-gol.github.io">Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://just-gol.github.io/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/">https://just-gol.github.io/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Solana/">Solana</a></div><div class="post-share"><div class="social-share" data-image="/img/815c217a-ec50-48ef-8d79-30f543f553de.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/07/24/%E9%93%BE%E4%B8%8A%E8%B4%A6%E6%88%B7%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B/" title="é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹</div></div><div class="info-2"><div class="info-item-1">âœ… ä½¿ç”¨åœºæ™¯åˆ›å»ºä¸€ä¸ª PDAï¼ˆProgram Derived Addressï¼‰æ¥å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œå¦‚å…³æ³¨åˆ—è¡¨ã€å‘å¸ƒå†…å®¹ã€æ‰“åˆ†æ•°æ®ç­‰ã€‚  ğŸ§± é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹ğŸ”¢ 1. ååºåˆ—åŒ–æŒ‡ä»¤å‚æ•°1let instruction = MyInstruction::try_from_slice(instruction_data)?;  åˆ¤æ–­å½“å‰æŒ‡ä»¤æ˜¯ Initã€Add è¿˜æ˜¯ Query ç­‰ã€‚  ğŸ”¢ 2. è·å–è´¦æˆ· AccountInfo åˆ—è¡¨1234let accounts_iter = &amp;mut accounts.iter();let payer = next_account_info(accounts_iter)?;let pda_account = next_account_info(accounts_iter)?;let system_program = next_account_info(accounts_iter)?;   ğŸ“ 3. è®¡ç®— PDAã€å…¬é’¥éªŒè¯12let (pda, bump) =...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/24/SPL%20Token/" title="SPL Token"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-24</div><div class="info-item-2">SPL Token</div></div><div class="info-2"><div class="info-item-1">solanaä¸Šçš„ä»£å¸ ä»£å¸æ˜¯ä»£è¡¨å¯¹å„ç§èµ„äº§æ‰€æœ‰æƒçš„æ•°å­—èµ„äº§ã€‚ ä»£å¸åŒ–ä½¿å¾—è´¢äº§æƒçš„æ•°å­—åŒ–æˆä¸ºå¯èƒ½ï¼Œæ˜¯ç®¡ç† å¯æ›¿ä»£å’Œä¸å¯æ›¿ä»£èµ„äº§çš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ã€‚ å¯æ›¿ä»£ä»£å¸ä»£è¡¨åŒç±»å‹å’ŒåŒä»·å€¼çš„å¯äº’æ¢å’Œå¯åˆ†å‰²èµ„äº§ï¼ˆä¾‹å¦‚ USDCï¼‰ã€‚ ä¸å¯æ›¿ä»£ä»£å¸ï¼ˆNFTï¼‰ä»£è¡¨ä¸å¯åˆ†å‰²èµ„äº§çš„æ‰€æœ‰æƒï¼ˆä¾‹å¦‚è‰ºæœ¯å“ï¼‰ã€‚    SPL (Solana Program Library) ä»£å¸ç¨‹åºï¼ˆToken Programï¼‰åŒ…å«ä¸ç½‘ç»œä¸Šçš„ä»£å¸ï¼ˆåŒ…æ‹¬å¯æ›¿ä»£å’Œä¸ å¯æ›¿ä»£ï¼‰äº¤äº’çš„æ‰€æœ‰æŒ‡ä»¤é€»è¾‘ã€‚ é“¸é€ è´¦æˆ·ï¼ˆMint Accountï¼‰ä»£è¡¨ä¸€ç§ç‰¹å®šç±»å‹çš„ä»£å¸ï¼Œå¹¶å­˜å‚¨å…³äºä»£ å¸çš„å…¨å±€å…ƒæ•°æ®ï¼Œå¦‚æ€»ä¾›åº”é‡å’Œé“¸é€ æƒé™ï¼ˆæœ‰æƒåˆ›å»ºæ–°ä»£å¸å•ä½çš„åœ°å€ï¼‰ã€‚ ä»£å¸è´¦æˆ·ï¼ˆToken Accountï¼‰è·Ÿè¸ªç‰¹å®šåœ°å€æ‹¥æœ‰çš„ç‰¹å®šç±»å‹ä»£å¸ï¼ˆé“¸ é€ è´¦æˆ·ï¼‰çš„å•ä½æ•°é‡ã€‚  SPL TOKENåˆ›å»ºMint Account é“¸å¸è´¦æˆ·spl-token create-token 1234567lsy@WIN-20240703PSE:~$ spl-token create-tokenCreating token...</div></div></div></a><a class="pagination-related" href="/2025/07/24/SPL%20Token%E7%AE%80%E5%8D%95%E5%90%88%E7%BA%A6/" title="SPL Tokenç®€å•åˆçº¦"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-24</div><div class="info-item-2">SPL Tokenç®€å•åˆçº¦</div></div><div class="info-2"><div class="info-item-1">Tokenåˆçº¦12cargo build-sbfsolana program deploy ./target/sbpf-solana-solana/release/token.so  æ•´ä½“ç»“æ„å¿«é€Ÿæ€»ç»“123456789// å…¥å£é€»è¾‘Processor::process(...) -&gt; è§£ææŒ‡ä»¤ -&gt; TokenInstruction::CreateToken or Mint -&gt; è°ƒç”¨å…·ä½“å‡½æ•°// åˆ›å»º Token çš„ Mint è´¦æˆ·fn create_token(...) &#123;...&#125;// å‘ ATA è´¦æˆ·é“¸å¸fn mint_token(...) &#123;...&#125;  å¤–éƒ¨ä¾èµ–åŒ…è¯´æ˜1234use borsh::BorshDeserialize; // è§£ææŒ‡ä»¤æ•°æ®ï¼ˆinstruction_dataï¼‰ç”¨use solana_program::*;       // Solana åŸç”Ÿå‘½ä»¤å’Œè´¦æˆ·ç³»ç»Ÿuse spl_token::*;            // Token æ ‡å‡†ç›¸å…³æŒ‡ä»¤ï¼Œå¦‚...</div></div></div></a><a class="pagination-related" href="/2025/07/16/solana%E5%AE%89%E8%A3%85/" title="solanaå®‰è£…"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-16</div><div class="info-item-2">solanaå®‰è£…</div></div><div class="info-2"><div class="info-item-1">æœ¬åœ°ç¯å¢ƒæ­å»ºlinux123456sudo apt-get updatesudo apt-get install -y \build-essential \pkg-config \libudev-dev llvm libclang-dev \protobuf-compiler libssl-dev  macos12xcode-select -p # check if installedxcode-select --install # install  Rustç¯å¢ƒå®‰è£… å¦‚æœå·²ç»å®‰è£…å¿½ç•¥  1curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y  Solana-cliå®‰è£… å»ºè®®å®‰è£…æ–°ç‰ˆæœ¬  12sh -c &quot;$(curl -sSfL https://release.anza.xyz/stable/install)&quot;sh -c &quot;$(curl -sSfL...</div></div></div></a><a class="pagination-related" href="/2025/07/17/solana%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" title="solanaå¼€å‘å…¥é—¨"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-17</div><div class="info-item-2">solanaå¼€å‘å…¥é—¨</div></div><div class="info-2"><div class="info-item-1">åˆ›å»ºAnchoré¡¹ç›®æ‰§è¡Œ anchor init xxx å¤±è´¥12lsy@WIN-20240703PSE:~$ anchor init todoError: yarn install failed: No such file or directory (os error 2)  éœ€è¦å®‰è£…  å…ˆç¡®ä¿ç³»ç»Ÿå®‰è£…äº† Node.js å’Œ npm    1npm install -g yarn  æ£€æŸ¥ yarn æ˜¯å¦å·²å®‰è£…1yarn -v  testsæ–‡ä»¶æŠ¥é”™ å®‰è£… TypeScript ç«¯çš„ Anchor SDK   12yarn install         # å®‰è£…ä¾èµ–ï¼ˆæˆ–è€… npm installï¼‰anchor build         # æ„å»ºåˆçº¦ï¼Œç”Ÿæˆ target/types  anchor buildæŠ¥é”™123456lsy@WIN-20240703PSE:~$ anchor --versionanchor-cli 0.31.1lsy@WIN-20240703PSE:~$ cargo --versioncargo 1.90.0-nightly (930b4f62c...</div></div></div></a><a class="pagination-related" href="/2025/07/24/%E8%B4%A6%E6%88%B7%E7%AE%80%E5%8D%95%E4%BA%A4%E4%BA%92/" title="è´¦æˆ·ç®€å•äº¤äº’"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-24</div><div class="info-item-2">è´¦æˆ·ç®€å•äº¤äº’</div></div><div class="info-2"><div class="info-item-1">Solana è´¦æˆ·æ¨¡å‹æ¦‚è§ˆ Solana æ²¡æœ‰ä»¥å¤ªåŠä¸­é‚£ç§â€œæ‹¥æœ‰é€»è¾‘çš„åˆçº¦è´¦æˆ·â€ï¼Œè€Œæ˜¯å°†æ•°æ®å’Œé€»è¾‘åˆ†ç¦»ï¼š      ç±»å‹ è¯´æ˜    è´¦æˆ·ï¼ˆAccountï¼‰ å­˜å‚¨çŠ¶æ€çš„æ•°æ®å®¹å™¨ï¼Œæ²¡æœ‰ä»£ç é€»è¾‘ã€‚   ç¨‹åºï¼ˆProgramï¼‰ çº¯é€»è¾‘ä»£ç ï¼Œæ˜¯åªè¯»çš„ï¼ˆä¸å¯æ›´æ”¹çš„ä»£ç ï¼‰ï¼Œè´Ÿè´£æ“ä½œè´¦æˆ·æ•°æ®ã€‚   ğŸ§¾ #[account] pub struct Xxx æ˜¯ç¨‹åºå†…éƒ¨å®šä¹‰çš„è´¦æˆ·æ•°æ®ç»“æ„è¯´æ˜ä¹¦ï¼Œå®ƒå¯¹åº”é“¾ä¸ŠæŸä¸ªè´¦æˆ·çš„ data å­—èŠ‚å¸ƒå±€ï¼› ğŸ§  ç¨‹åºï¼ˆProgramï¼‰æ˜¯éƒ¨ç½²åœ¨ Solana ä¸Šçš„æ™ºèƒ½åˆçº¦ï¼Œæ§åˆ¶å¯¹è´¦æˆ·æ•°æ®çš„è¯»å†™ï¼Œæ˜¯ executable = true çš„ç‰¹æ®Šè´¦æˆ·ã€‚   è´¦æˆ·çš„ç»“æ„1234567Account &#123;  lamports: u64,             // å½“å‰è´¦æˆ·ä½™é¢ï¼ˆä»¥ lamport è®¡ï¼Œ1 SOL = 10^9 lamportï¼‰  owner: Pubkey,             // æ§åˆ¶è¯¥è´¦æˆ·çš„ç¨‹åºï¼ˆç¨‹åºçš„å…¬é’¥ï¼‰  data: Vec&lt;u8&gt;,             // è´¦æˆ·ä¸­å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆæœ€å¤šå¯è¢«ä¸€ä¸ªç¨‹åºè§£é‡Šï¼‰ ...</div></div></div></a><a class="pagination-related" href="/2025/07/24/%E9%93%BE%E4%B8%8A%E8%B4%A6%E6%88%B7%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B/" title="é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-24</div><div class="info-item-2">é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹</div></div><div class="info-2"><div class="info-item-1">âœ… ä½¿ç”¨åœºæ™¯åˆ›å»ºä¸€ä¸ª PDAï¼ˆProgram Derived Addressï¼‰æ¥å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œå¦‚å…³æ³¨åˆ—è¡¨ã€å‘å¸ƒå†…å®¹ã€æ‰“åˆ†æ•°æ®ç­‰ã€‚  ğŸ§± é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹ğŸ”¢ 1. ååºåˆ—åŒ–æŒ‡ä»¤å‚æ•°1let instruction = MyInstruction::try_from_slice(instruction_data)?;  åˆ¤æ–­å½“å‰æŒ‡ä»¤æ˜¯ Initã€Add è¿˜æ˜¯ Query ç­‰ã€‚  ğŸ”¢ 2. è·å–è´¦æˆ· AccountInfo åˆ—è¡¨1234let accounts_iter = &amp;mut accounts.iter();let payer = next_account_info(accounts_iter)?;let pda_account = next_account_info(accounts_iter)?;let system_program = next_account_info(accounts_iter)?;   ğŸ“ 3. è®¡ç®— PDAã€å…¬é’¥éªŒè¯12let (pda, bump) =...</div></div></div></a></div></div><!-- if page.comments !== false && theme.comments.use--><!--   - var commentsJsLoad = true--><!--   !=partial('includes/third-party/comments/index', {}, {cache: true})--><!-- âœ… æ¥å¿…åŠ›è¯„è®ºæ¡†ï¼ˆæ­£ç¡®ä½ç½®ï¼Œç¼©è¿›æ— è¯¯ï¼‰--><div id="lv-container" data-id="city" data-uid="MTAyMC82MDc5NS8zNzI2NQ=="></div><script>(function(d, s) {
  var j, e = d.getElementsByTagName(s)[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.parentNode.insertBefore(j, e);
})(document, 'script');</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´» JavaScript</noscript></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/815c217a-ec50-48ef-8d79-30f543f553de.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Li</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/just-gol/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#admin"><span class="toc-number">1.</span> <span class="toc-text">admin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#create-amm-config-%E5%88%9B%E5%BB%BA-AMM-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">create_amm_config(åˆ›å»º AMM é…ç½®)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-amm-config-%E6%9B%B4%E6%96%B0-AMM-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">update_amm_config(æ›´æ–° AMM é…ç½®)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-pool-status-%E6%9B%B4%E6%96%B0%E6%B1%A0%E5%AD%90%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">update_pool_status(æ›´æ–°æ± å­çŠ¶æ€)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collect-protocol-fee-%E6%8F%90%E5%8F%96%E6%B1%A0%E5%AD%90%E7%B4%AF%E7%A7%AF%E7%9A%84%E5%8D%8F%E8%AE%AE%E8%B4%B9"><span class="toc-number">1.4.</span> <span class="toc-text">collect_protocol_fee(æå–æ± å­ç´¯ç§¯çš„åè®®è´¹)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">ä¸¾ä¾‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collect-fund-fee-%E6%8F%90%E5%8F%96%E6%B1%A0%E5%AD%90%E7%B4%AF%E7%A7%AF%E7%9A%84%E8%B5%84%E9%87%91%E8%B4%B9%E7%94%A8"><span class="toc-number">1.5.</span> <span class="toc-text">collect_fund_fee(æå–æ± å­ç´¯ç§¯çš„èµ„é‡‘è´¹ç”¨)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#User"><span class="toc-number">2.</span> <span class="toc-text">User</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#initialize-%E5%88%9B%E5%BB%BA%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">2.1.</span> <span class="toc-text">initialize(åˆ›å»ºæµåŠ¨æ€§)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Initialize%E7%BB%93%E6%9E%84%E4%BD%93%E5%AD%97%E6%AE%B5"><span class="toc-number">2.1.1.</span> <span class="toc-text">Initializeç»“æ„ä½“å­—æ®µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D%E5%92%8C%E5%8F%82%E6%95%B0"><span class="toc-number">2.1.2.</span> <span class="toc-text">å‡½æ•°ç­¾åå’Œå‚æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%A0%A1%E9%AA%8C-mint-%E6%98%AF%E5%90%A6%E5%8F%97%E6%94%AF%E6%8C%81"><span class="toc-number">2.1.3.</span> <span class="toc-text">ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒ mint æ˜¯å¦å—æ”¯æŒ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E7%9A%84%EF%BC%9A"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">ç›®çš„ï¼š</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E5%BB%BA%E6%B1%A0"><span class="toc-number">2.1.4.</span> <span class="toc-text">ç¬¬äºŒæ­¥ï¼šæ˜¯å¦å…è®¸å»ºæ± </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E8%B0%83%E6%95%B4%E5%BC%80%E6%94%BE%E6%97%B6%E9%97%B4-open-time"><span class="toc-number">2.1.5.</span> <span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šè°ƒæ•´å¼€æ”¾æ—¶é—´ open_time</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E4%B8%BA%E6%B1%A0%E5%88%9B%E5%BB%BA-2-%E4%B8%AA-vault-%E8%B4%A6%E6%88%B7"><span class="toc-number">2.1.6.</span> <span class="toc-text">ç¬¬å››æ­¥ï¼šä¸ºæ± åˆ›å»º 2 ä¸ª vault è´¦æˆ·</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%B1%A0%E7%8A%B6%E6%80%81%E8%B4%A6%E6%88%B7-pool-state"><span class="toc-number">2.1.7.</span> <span class="toc-text">ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ± çŠ¶æ€è´¦æˆ· pool_state</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96-observation-%E7%8A%B6%E6%80%81%EF%BC%88%E8%AE%B0%E5%BD%95%E4%BB%B7%E6%A0%BC%E4%BF%A1%E6%81%AF%EF%BC%89"><span class="toc-number">2.1.8.</span> <span class="toc-text">ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ– observation çŠ¶æ€ï¼ˆè®°å½•ä»·æ ¼ä¿¡æ¯ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9A%E8%BD%AC%E5%85%A5%E5%88%9D%E5%A7%8B-token-%E5%88%B0-vault"><span class="toc-number">2.1.9.</span> <span class="toc-text">ç¬¬ä¸ƒæ­¥ï¼šè½¬å…¥åˆå§‹ token åˆ° vault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E4%BB%8E-vault-%E8%B4%A6%E6%88%B7%E4%B8%AD%E8%AF%BB%E5%8F%96%E4%BD%99%E9%A2%9D%EF%BC%8C%E9%AA%8C%E8%AF%81%E5%88%9D%E5%A7%8B-token-%E6%95%B0%E9%87%8F%E6%98%AF%E5%90%A6%E5%90%88%E7%90%86"><span class="toc-number">2.1.10.</span> <span class="toc-text">ç¬¬å…«æ­¥ï¼šä» vault è´¦æˆ·ä¸­è¯»å–ä½™é¢ï¼ŒéªŒè¯åˆå§‹ token æ•°é‡æ˜¯å¦åˆç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E6%AD%A5%EF%BC%9A%E8%AE%A1%E7%AE%97%E5%88%9D%E5%A7%8B-LP-token-%E7%9A%84%E6%95%B0%E9%87%8F%EF%BC%88%E6%B5%81%E5%8A%A8%E6%80%A7%EF%BC%89"><span class="toc-number">2.1.11.</span> <span class="toc-text">ç¬¬ä¹æ­¥ï¼šè®¡ç®—åˆå§‹ LP token çš„æ•°é‡ï¼ˆæµåŠ¨æ€§ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E6%AD%A5%EF%BC%9A%E6%89%A3%E9%99%A4%E5%88%9B%E5%BB%BA%E6%B1%A0%E6%89%8B%E7%BB%AD%E8%B4%B9%EF%BC%88%E5%A6%82%E6%9E%9C%E9%85%8D%E7%BD%AE%E6%9C%89%EF%BC%89"><span class="toc-number">2.1.12.</span> <span class="toc-text">ç¬¬åæ­¥ï¼šæ‰£é™¤åˆ›å»ºæ± æ‰‹ç»­è´¹ï¼ˆå¦‚æœé…ç½®æœ‰ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96-pool-state-%E5%86%85%E5%AE%B9"><span class="toc-number">2.1.13.</span> <span class="toc-text">ç¬¬åä¸€æ­¥ï¼šåˆå§‹åŒ– pool_state å†…å®¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E6%88%90%E5%8A%9F"><span class="toc-number">2.1.14.</span> <span class="toc-text">è¿”å›æˆåŠŸ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%B5%81%E5%8A%A8-%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4"><span class="toc-number">2.1.15.</span> <span class="toc-text">æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹æ•°æ®æµåŠ¨ &amp; çŠ¶æ€å˜æ›´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMM%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B4%A6%E6%88%B7%E9%A1%B8%E5%9B%BE"><span class="toc-number">2.1.16.</span> <span class="toc-text">AMMåˆå§‹åŒ–è´¦æˆ·é¡¸å›¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.17.</span> <span class="toc-text">é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#token-0-mint%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%94token-1-mint%E5%B0%8F"><span class="toc-number">2.1.17.1.</span> <span class="toc-text">token_0_mintä¸ºä»€ä¹ˆæ¯”token_1_mintå°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88signer-seeds%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AFtoken-1-vault"><span class="toc-number">2.1.17.2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆsigner_seedsä¸ºä»€ä¹ˆæ˜¯token_1_vault</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deposit-%E6%B7%BB%E5%8A%A0%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">2.2.</span> <span class="toc-text">deposit(æ·»åŠ æµåŠ¨æ€§)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.2.1.</span> <span class="toc-text">å‚æ•°æ ¡éªŒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E5%AD%98%E5%85%A5"><span class="toc-number">2.2.2.</span> <span class="toc-text">æ ¡éªŒæ˜¯å¦å…è®¸å­˜å…¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D-vault-%E4%B8%AD%E7%9A%84-token-%E6%95%B0%E9%87%8F%EF%BC%88%E6%89%A3%E6%8E%89%E6%9C%AA%E6%94%B6%E6%89%8B%E7%BB%AD%E8%B4%B9%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">è·å–å½“å‰ vault ä¸­çš„ token æ•°é‡ï¼ˆæ‰£æ‰æœªæ”¶æ‰‹ç»­è´¹ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE-LP-token-%E6%95%B0%E9%87%8F-%E2%86%92-%E5%8F%8D%E6%8E%A8%E7%94%A8%E6%88%B7%E8%A6%81%E6%8F%90%E4%BE%9B%E7%9A%84-token0-token1"><span class="toc-number">2.2.4.</span> <span class="toc-text">æ ¹æ® LP token æ•°é‡ â†’ åæ¨ç”¨æˆ·è¦æä¾›çš„ token0&#x2F;token1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">å…·ä½“å®ç°é€»è¾‘</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%AE%A1%E7%AE%97%E9%80%BB%E8%BE%91"><span class="toc-number">2.2.4.1.1.</span> <span class="toc-text">æ ¸å¿ƒè®¡ç®—é€»è¾‘</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#RoundDirection-Ceiling-%E7%89%B9%E6%AE%8A%E9%80%BB%E8%BE%91"><span class="toc-number">2.2.4.1.2.</span> <span class="toc-text">RoundDirection::Ceiling ç‰¹æ®Šé€»è¾‘</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%83%E8%99%91-Transfer-Fee-%E7%9A%84%E5%8F%8D%E5%90%91%E6%8D%A2%E7%AE%97"><span class="toc-number">2.2.5.</span> <span class="toc-text">è€ƒè™‘ Transfer Fee çš„åå‘æ¢ç®—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%91%E7%82%B9%E5%88%A4%E6%96%AD"><span class="toc-number">2.2.6.</span> <span class="toc-text">æ»‘ç‚¹åˆ¤æ–­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E5%AE%9E%E9%99%85%E8%BD%AC%E8%B4%A6-token0-%E5%92%8C-token1"><span class="toc-number">2.2.7.</span> <span class="toc-text">å¼€å§‹å®é™…è½¬è´¦ token0 å’Œ token1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%B1%A0%E5%AD%90%E7%9A%84-LP-%E6%80%BB%E9%87%8F-%E7%BB%99%E7%94%A8%E6%88%B7%E9%93%B8%E9%80%A0-LP-token"><span class="toc-number">2.2.8.</span> <span class="toc-text">ä¿®æ”¹æ± å­çš„ LP æ€»é‡ &amp; ç»™ç”¨æˆ·é“¸é€  LP token</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%9C%80%E6%96%B0-epoch%EF%BC%8C%E5%AE%8C%E6%88%90"><span class="toc-number">2.2.9.</span> <span class="toc-text">è®°å½•æœ€æ–° epochï¼Œå®Œæˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E5%85%B3%E5%BF%83%E7%9A%84%E5%87%A0%E4%B8%AA%E7%82%B9"><span class="toc-number">2.2.10.</span> <span class="toc-text">å¯èƒ½å…³å¿ƒçš„å‡ ä¸ªç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lp-tokens-to-trading-tokens-%E6%98%AF%E6%80%8E%E4%B9%88%E8%AE%A1%E7%AE%97-token-%E6%95%B0%E9%87%8F%E7%9A%84%EF%BC%9F"><span class="toc-number">2.2.10.1.</span> <span class="toc-text">lp_tokens_to_trading_tokens æ˜¯æ€ä¹ˆè®¡ç®— token æ•°é‡çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#transfer-fee-%E7%9B%B8%E5%85%B3%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%8A%A0%EF%BC%9F"><span class="toc-number">2.2.10.2.</span> <span class="toc-text">transfer_fee ç›¸å…³ä¸ºä»€ä¹ˆéœ€è¦åŠ ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E6%9C%80%E5%A4%A7-token0-%E5%92%8C-token1-%E5%8F%82%E6%95%B0%EF%BC%9F"><span class="toc-number">2.2.10.3.</span> <span class="toc-text">ä¸ºä»€ä¹ˆæœ‰æœ€å¤§ token0 å’Œ token1 å‚æ•°ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.2.11.</span> <span class="toc-text">æ€»ç»“æµç¨‹å›¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#withdraw-%E6%8F%90%E7%8E%B0%E5%87%8F%E5%B0%91%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">2.3.</span> <span class="toc-text">withdraw(æç°å‡å°‘æµåŠ¨æ€§)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#swap-base-input-%E5%9F%BA%E4%BA%8E%E8%BE%93%E5%85%A5%E7%9A%84%E6%95%B0%E9%87%8F%E8%BF%9B%E8%A1%8C%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.4.</span> <span class="toc-text">swap_base_input(åŸºäºè¾“å…¥çš„æ•°é‡è¿›è¡Œäº¤æ¢)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%A0%A1%E9%AA%8C%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E4%BA%A4%E6%8D%A2"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. æ ¡éªŒæ˜¯å¦å…è®¸äº¤æ¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%89%A3%E9%99%A4%E8%BE%93%E5%85%A5%E8%BD%AC%E8%B4%A6%E6%89%8B%E7%BB%AD%E8%B4%B9"><span class="toc-number">2.4.2.</span> <span class="toc-text">2. æ‰£é™¤è¾“å…¥è½¬è´¦æ‰‹ç»­è´¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%A4%E6%96%AD%E8%BE%93%E5%85%A5-%E8%BE%93%E5%87%BA-vault-%E6%98%AF-token0-%E8%BF%98%E6%98%AF-token1"><span class="toc-number">2.4.3.</span> <span class="toc-text">3. åˆ¤æ–­è¾“å…¥&#x2F;è¾“å‡º vault æ˜¯ token0 è¿˜æ˜¯ token1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%B0%83%E7%94%A8%E6%A0%B8%E5%BF%83%E6%9B%B2%E7%BA%BF%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.4.</span> <span class="toc-text">4. è°ƒç”¨æ ¸å¿ƒæ›²çº¿å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">è¯¦è§£</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E8%AE%A1%E7%AE%97%EF%BC%9A"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">æ­¥éª¤è®¡ç®—ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%80%BB%E4%BA%A4%E6%98%93%E6%89%8B%E7%BB%AD%E8%B4%B9-trade-fee"><span class="toc-number">2.4.4.2.1.</span> <span class="toc-text">è®¡ç®—æ€»äº¤æ˜“æ‰‹ç»­è´¹ trade_fee</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%86%E6%91%8A%E5%8D%8F%E8%AE%AE%E8%B4%B9%E5%92%8C%E5%9F%BA%E9%87%91%E8%B4%B9"><span class="toc-number">2.4.4.2.2.</span> <span class="toc-text">åˆ†æ‘Šåè®®è´¹å’ŒåŸºé‡‘è´¹</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E7%94%A8%E4%BA%8E%E4%BA%A4%E6%98%93%E7%9A%84%E5%87%80%E8%BE%93%E5%85%A5%E6%95%B0%E9%87%8F"><span class="toc-number">2.4.4.2.3.</span> <span class="toc-text">å®é™…ç”¨äºäº¤æ˜“çš„å‡€è¾“å…¥æ•°é‡</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E7%94%A8%E6%88%B7%E5%8F%AF%E8%8E%B7%E5%BE%97%E7%9A%84%E7%9B%AE%E6%A0%87-token%EF%BC%88%E7%94%A8%E6%81%92%E5%AE%9A%E4%B9%98%E7%A7%AF%E5%85%AC%E5%BC%8F%EF%BC%89%EF%BC%9A"><span class="toc-number">2.4.4.2.4.</span> <span class="toc-text">è®¡ç®—ç”¨æˆ·å¯è·å¾—çš„ç›®æ ‡ tokenï¼ˆç”¨æ’å®šä¹˜ç§¯å…¬å¼ï¼‰ï¼š</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%81%92%E5%AE%9A%E4%B9%98%E7%A7%AF%E6%9B%B2%E7%BA%BF%E5%85%AC%E5%BC%8F%EF%BC%88x-y-k%EF%BC%89"><span class="toc-number">2.4.4.2.5.</span> <span class="toc-text">æ’å®šä¹˜ç§¯æ›²çº¿å…¬å¼ï¼ˆx * y &#x3D; kï¼‰:</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%BB%93%E6%9E%9C%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%9A"><span class="toc-number">2.4.4.2.6.</span> <span class="toc-text">ç”Ÿæˆç»“æœç»“æ„ä½“ï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%A0%A1%E9%AA%8C%E4%BA%A4%E6%8D%A2%E5%89%8D%E5%90%8E%E5%B8%B8%E6%95%B0%E4%B9%98%E7%A7%AF%E5%85%B3%E7%B3%BB"><span class="toc-number">2.4.5.</span> <span class="toc-text">5. æ ¡éªŒäº¤æ¢å‰åå¸¸æ•°ä¹˜ç§¯å…³ç³»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%A3%80%E6%9F%A5%E8%BE%93%E5%87%BA-token-%E5%87%8F%E5%8E%BB%E6%89%8B%E7%BB%AD%E8%B4%B9%E6%98%AF%E5%90%A6-%E2%89%A5-%E7%94%A8%E6%88%B7%E8%AE%BE%E7%BD%AE%E7%9A%84%E6%9C%80%E5%B0%8F%E6%8E%A5%E5%8F%97%E5%80%BC"><span class="toc-number">2.4.6.</span> <span class="toc-text">6. æ£€æŸ¥è¾“å‡º token å‡å»æ‰‹ç»­è´¹æ˜¯å¦ â‰¥ ç”¨æˆ·è®¾ç½®çš„æœ€å°æ¥å—å€¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E7%B4%AF%E5%8A%A0-protocol-%E5%92%8C-fund-%E6%89%8B%E7%BB%AD%E8%B4%B9%E5%88%B0%E6%B1%A0%E7%9A%84-fee-%E5%AD%97%E6%AE%B5"><span class="toc-number">2.4.7.</span> <span class="toc-text">7. ç´¯åŠ  protocol å’Œ fund æ‰‹ç»­è´¹åˆ°æ± çš„ fee å­—æ®µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E6%89%A7%E8%A1%8C%E8%BD%AC%E8%B4%A6%EF%BC%9A"><span class="toc-number">2.4.8.</span> <span class="toc-text">8. æ‰§è¡Œè½¬è´¦ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E8%AE%B0%E5%BD%95-token-%E4%BB%B7%E6%A0%BC%E8%A7%82%E5%AF%9F%E6%95%B0%E6%8D%AE"><span class="toc-number">2.5.</span> <span class="toc-text">9. è®°å½• token ä»·æ ¼è§‚å¯Ÿæ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#emit-Event"><span class="toc-number">3.</span> <span class="toc-text">emit Event</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.0.1.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/25/swap%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/" title="swapé¡¹ç›®æ‹†è§£">swapé¡¹ç›®æ‹†è§£</a><time datetime="2025-08-25T11:53:19.000Z" title="Created 2025-08-25 19:53:19">2025-08-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/%E9%93%BE%E4%B8%8A%E8%B4%A6%E6%88%B7%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B/" title="é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹">é“¾ä¸Šè´¦æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡å‡†æµç¨‹</a><time datetime="2025-07-24T07:27:58.000Z" title="Created 2025-07-24 15:27:58">2025-07-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/SPL%20Token%E7%AE%80%E5%8D%95%E5%90%88%E7%BA%A6/" title="SPL Tokenç®€å•åˆçº¦">SPL Tokenç®€å•åˆçº¦</a><time datetime="2025-07-24T07:27:16.000Z" title="Created 2025-07-24 15:27:16">2025-07-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/SPL%20Token/" title="SPL Token">SPL Token</a><time datetime="2025-07-24T07:24:39.000Z" title="Created 2025-07-24 15:24:39">2025-07-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/24/%E8%B4%A6%E6%88%B7%E7%AE%80%E5%8D%95%E4%BA%A4%E4%BA%92/" title="è´¦æˆ·ç®€å•äº¤äº’">è´¦æˆ·ç®€å•äº¤äº’</a><time datetime="2025-07-24T07:21:58.000Z" title="Created 2025-07-24 15:21:58">2025-07-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Li</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>